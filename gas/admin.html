<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            navy:      { DEFAULT: '#1B2A4A', light: '#2A3E66', dark: '#111D35' },
            gold:      { DEFAULT: '#C4972F', light: '#D4AD4E' },
            bg:        '#F8F7F4',
          },
          fontFamily: { sans: ['Inter', 'sans-serif'] },
        },
      },
    }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <?!= include('styles') ?>
</head>
<body class="bg-bg text-gray-800 min-h-screen flex flex-col md:pl-64" x-data="adminApp()" x-init="init()">

  <!-- Navbar -->
  <nav class="bg-navy text-white px-6 py-4 flex justify-between items-center shadow-md">
    <div class="flex items-center gap-3">
      <div class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center text-gold">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/></svg>
      </div>
      <span class="font-semibold tracking-tight">Admin Console</span>
    </div>
    <div class="flex items-center gap-4">
      <a href="<?= appUrl ?>" class="text-sm text-gray-300 hover:text-white transition">Back to Home</a>
    </div>
  </nav>

  <!-- Sidebar (New) -->
  <aside class="fixed top-0 left-0 h-full w-64 bg-navy-dark text-white shadow-lg transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out z-40"
         :class="{'translate-x-0': sidebarOpen}"
         @click.away="sidebarOpen = false">
    <div class="p-6 flex items-center justify-between border-b border-navy-700">
      <div class="flex items-center gap-3">
        <div class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center text-gold">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/></svg>
        </div>
        <span class="font-semibold tracking-tight">Admin Console</span>
      </div>
      <button @click="sidebarOpen = false" class="md:hidden text-gray-400 hover:text-white">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
      </button>
    </div>

    <nav class="flex-1 px-4 py-6 space-y-2">
      <a href="#" class="flex items-center gap-3 px-3 py-2 rounded-lg text-sm font-medium text-gray-300 hover:bg-navy-light hover:text-white transition"
         :class="activeTab === 'users' ? 'bg-navy-light text-white' : ''"
         @click.prevent="switchTab('users')">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.653-.165-1.294-.478-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.653.165-1.294.478-1.857m0 0A5.002 5.002 0 0112 16a5.002 5.002 0 014.522 2.143M12 16V9m-2 2V9m4 2V9m-4-4h.01M12 4h.01"/></svg>
        Users
      </a>
      <a href="#" class="flex items-center gap-3 px-3 py-2 rounded-lg text-sm font-medium text-gray-300 hover:bg-navy-light hover:text-white transition"
         :class="activeTab === 'instructors' ? 'bg-navy-light text-white' : ''"
         @click.prevent="switchTab('instructors')">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
        Instructors
      </a>
      <a href="#" class="flex items-center gap-3 px-3 py-2 rounded-lg text-sm font-medium text-gray-300 hover:bg-navy-light hover:text-white transition"
         :class="activeTab === 'students' ? 'bg-navy-light text-white' : ''"
         @click.prevent="switchTab('students')">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
        Students
      </a>
      <a href="#" class="flex items-center gap-3 px-3 py-2 rounded-lg text-sm font-medium text-gray-300 hover:bg-navy-light hover:text-white transition"
         :class="activeTab === 'divisions' ? 'bg-navy-light text-white' : ''"
         @click.prevent="switchTab('divisions')">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/></svg>
        Divisions
      </a>
      <a href="#" class="flex items-center gap-3 px-3 py-2 rounded-lg text-sm font-medium text-gray-300 hover:bg-navy-light hover:text-white transition"
         :class="activeTab === 'floors' ? 'bg-navy-light text-white' : ''"
         @click.prevent="switchTab('floors')">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 14v3m4-3v3m4-3v3M3 21h18M3 10h18M3 7l9-4 9 4M4 10h16v11H4V10z"/></svg>
        Floors
      </a>
      <a href="#" class="flex items-center gap-3 px-3 py-2 rounded-lg text-sm font-medium text-gray-300 hover:bg-navy-light hover:text-white transition"
         :class="activeTab === 'phases' ? 'bg-navy-light text-white' : ''"
         @click.prevent="switchTab('phases')">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/></svg>
        Treatment Phases
      </a>
      <a href="#" class="flex items-center gap-3 px-3 py-2 rounded-lg text-sm font-medium text-gray-300 hover:bg-navy-light hover:text-white transition"
         :class="activeTab === 'catalog' ? 'bg-navy-light text-white' : ''"
         @click.prevent="switchTab('catalog')">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>
        Treatment Catalog
      </a>
      <a href="#" class="flex items-center gap-3 px-3 py-2 rounded-lg text-sm font-medium text-gray-300 hover:bg-navy-light hover:text-white transition"
         :class="activeTab === 'steps' ? 'bg-navy-light text-white' : ''"
         @click.prevent="switchTab('steps')">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"/></svg>
        Treatment Steps
      </a>
      <a href="#" class="flex items-center gap-3 px-3 py-2 rounded-lg text-sm font-medium text-gray-300 hover:bg-navy-light hover:text-white transition"
         :class="activeTab === 'requirements' ? 'bg-navy-light text-white' : ''"
         @click.prevent="switchTab('requirements')">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
        Requirements
      </a>
      <a href="#" class="flex items-center gap-3 px-3 py-2 rounded-lg text-sm font-medium text-gray-300 hover:bg-navy-light hover:text-white transition"
         :class="activeTab === 'caseTypes' ? 'bg-navy-light text-white' : ''"
         @click.prevent="switchTab('caseTypes')">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>
        Case Types
      </a>
      <a href="#" class="flex items-center gap-3 px-3 py-2 rounded-lg text-sm font-medium text-gray-300 hover:bg-navy-light hover:text-white transition"
         :class="activeTab === 'patients' ? 'bg-navy-light text-white' : ''"
         @click.prevent="switchTab('patients')">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.653-.165-1.294-.478-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.653.165-1.294.478-1.857m0 0A5.002 5.002 0 0112 16a5.002 5.002 0 014.522 2.143M12 16V9m-2 2V9m4 2V9m-4-4h.01M12 4h.01"/></svg>
        Patients
      </a>
    </nav>

    <!-- User Profile -->
      <div class="p-4 border-t border-navy-700">
        <div class="flex items-center gap-3 mb-4">
          <div class="w-8 h-8 rounded-full bg-navy-700 flex items-center justify-center text-xs font-bold text-white">
            AD
          </div>
          <div>
            <div class="text-sm font-medium text-white">Admin User</div>
            <div class="text-xs text-gray-400">admin@rsu.ac.th</div>
          </div>
        </div>

        <!-- Maintenance Mode Toggle -->
        <div class="border-t border-navy-700 pt-3">
          <label class="flex items-center justify-between cursor-pointer">
             <span class="text-xs font-medium text-gray-300">Maintenance Mode</span>
             <div class="relative inline-block w-8 h-4 align-middle select-none transition duration-200 ease-in">
                <input type="checkbox" x-model="maintenanceMode" @change="toggleMaintenance" class="toggle-checkbox absolute block w-4 h-4 rounded-full bg-white border-4 appearance-none cursor-pointer duration-200 ease-in placeholder-shown:bg-gray-300 focus:outline-none"/>
                <label class="toggle-label block overflow-hidden h-4 rounded-full bg-gray-600 cursor-pointer"></label>
            </div>
          </label>
           
           <!-- System Health Status -->
           <div class="mt-3 pt-3 border-t border-navy-700">
             <div class="flex items-center justify-between text-[10px] text-gray-400 mb-1">
               <span>Active Source:</span>
               <span class="font-bold" :class="health.source === 'supabase' ? 'text-emerald-400' : 'text-gold'" x-text="health.source === 'supabase' ? 'Supabase' : 'Sheets (Fallback)'"></span>
             </div>
             <div class="flex items-center justify-between text-[10px] text-gray-400">
               <span>Connection:</span>
               <span :class="health.healthy ? 'text-emerald-400' : 'text-red-400'" x-text="health.healthy ? 'OK' : 'Error/Offline'"></span>
             </div>
           </div>
        </div>
      </div>
  </aside>

  <!-- Main Content -->
  <main class="flex-1 max-w-7xl w-full mx-auto p-6">
    
    <!-- Title & Search & Tabs -->
    <div class="flex flex-col gap-6 mb-8">
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
        <div>
          <h1 class="text-2xl font-bold text-navy">Admin Console</h1>
          <p class="text-sm text-gray-500">Manage system users and configurations.</p>
        </div>
        <div class="flex items-center gap-3 w-full sm:w-auto">
          <input type="text" x-model="search" placeholder="Search..." 
                 class="px-4 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-navy focus:border-transparent w-full sm:w-64">
          <button @click="openModal('create')" 
                  x-show="activeTab !== 'patients'"
                  class="bg-navy hover:bg-navy-light text-white px-4 py-2 rounded-lg text-sm font-medium transition shadow-sm flex items-center gap-2 whitespace-nowrap">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
            <span x-text="activeTab === 'users' ? 'Add User' : (activeTab === 'instructors' ? 'Add Instructor' : (activeTab === 'divisions' ? 'Add Division' : (activeTab === 'floors' ? 'Add Floor' : (activeTab === 'phases' ? 'Add Phase' : (activeTab === 'catalog' ? 'Add Treatment' : (activeTab === 'caseTypes' ? 'Add Case Type' : (activeTab === 'steps' ? 'Add Step' : 'Add Requirement'))))))))"></span>
          </button>
        </div>
      </div>

      <!-- Tabs -->
      <div class="border-b border-gray-200">
        <nav class="-mb-px flex space-x-8">
          <button @click="switchTab('users')" 
                  class="whitespace-nowrap pb-4 px-1 border-b-2 font-medium text-sm transition"
                  :class="activeTab === 'users' ? 'border-navy text-navy' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'">
            Users
          </button>
          <button @click="switchTab('instructors')" 
                  class="whitespace-nowrap pb-4 px-1 border-b-2 font-medium text-sm transition"
                  :class="activeTab === 'instructors' ? 'border-navy text-navy' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'">
            Instructors
          </button>
          <button @click="switchTab('students')" 
                  class="whitespace-nowrap pb-4 px-1 border-b-2 font-medium text-sm transition"
                  :class="activeTab === 'students' ? 'border-navy text-navy' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'">
            Students
          </button>
          <button @click="switchTab('divisions')" 
                  class="whitespace-nowrap pb-4 px-1 border-b-2 font-medium text-sm transition"
                  :class="activeTab === 'divisions' ? 'border-navy text-navy' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'">
            Divisions
          </button>
          <button @click="switchTab('floors')" 
                  class="whitespace-nowrap pb-4 px-1 border-b-2 font-medium text-sm transition"
                  :class="activeTab === 'floors' ? 'border-navy text-navy' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'">
            Floors
          </button>
          <button @click="switchTab('phases')" 
                  class="whitespace-nowrap pb-4 px-1 border-b-2 font-medium text-sm transition"
                  :class="activeTab === 'phases' ? 'border-navy text-navy' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'">
            Treatment Phases
          </button>
          <button @click="switchTab('catalog')" 
                  class="whitespace-nowrap pb-4 px-1 border-b-2 font-medium text-sm transition"
                  :class="activeTab === 'catalog' ? 'border-navy text-navy' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'">
            Treatment Catalog
          </button>
          <button @click="switchTab('caseTypes')" 
                  class="whitespace-nowrap pb-4 px-1 border-b-2 font-medium text-sm transition"
                  :class="activeTab === 'caseTypes' ? 'border-navy text-navy' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'">
            Case Types
          </button>
          <button @click="switchTab('steps')" 
                  class="whitespace-nowrap pb-4 px-1 border-b-2 font-medium text-sm transition"
                  :class="activeTab === 'steps' ? 'border-navy text-navy' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'">
            Treatment Steps
          </button>
          <button @click="switchTab('requirements')" 
                  class="whitespace-nowrap pb-4 px-1 border-b-2 font-medium text-sm transition"
                  :class="activeTab === 'requirements' ? 'border-navy text-navy' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'">
            Requirements
          </button>
          <button @click="switchTab('patients')" 
                  class="whitespace-nowrap pb-4 px-1 border-b-2 font-medium text-sm transition"
                  :class="activeTab === 'patients' ? 'border-navy text-navy' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'">
            Patients
          </button>
        </nav>
      </div>
      <div>
        <div class="flex items-center space-x-2">
           <!-- Maintenance Toggle -->
    <div x-show="loading" class="flex justify-center py-12">
      <div class="spinner"></div>
    </div>

    <!-- Instructors Tab -->
    <div x-show="!loading && activeTab === 'instructors'" class="space-y-6 animate-fade-in">
       <!-- Sync Section -->
       <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex flex-col sm:flex-row justify-between items-center gap-4">
          <div>
            <h2 class="text-lg font-bold text-navy flex items-center gap-2">
               <svg class="w-5 h-5 text-gold" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
               Sync from Master Sheet
            </h2>
            <p class="text-sm text-gray-500 mt-1">Sync instructors from Google Sheet (Teacher, Active, Permanent).</p>
          </div>
          <div class="flex items-center gap-3">
             <div x-show="syncResult" class="text-xs font-medium px-3 py-1.5 rounded-lg" 
                  :class="syncResult && syncResult.success ? 'bg-green-50 text-green-700' : 'bg-red-50 text-red-700'">
                <span x-text="syncResultMessage"></span>
             </div>
             <button @click="syncInstructors" :disabled="syncing" 
                     class="bg-navy hover:bg-navy-light text-white px-4 py-2 rounded-lg text-sm font-medium transition shadow-sm flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
               <svg class="w-4 h-4" :class="{'animate-spin': syncing}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
               <span x-text="syncing ? 'Syncing...' : 'Sync Instructors'"></span>
             </button>
          </div>
       </div>

       <!-- Table -->
       <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
        <table class="w-full text-left border-collapse">
          <thead>
            <tr class="bg-gray-50 border-b border-gray-200 text-xs text-gray-500 uppercase tracking-wider font-semibold">
              <th class="px-6 py-4">Name / Email</th>
              <th class="px-6 py-4">Division</th>
              <th class="px-6 py-4">Details</th>
              <th class="px-6 py-4">Location</th>
              <th class="px-6 py-4 text-right">Actions</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-100">
            <template x-for="inst in filteredInstructors" :key="inst.instructor_id">
              <tr class="hover:bg-gray-50/50 transition">
                <td class="px-6 py-4">
                  <div class="font-medium text-navy" x-text="inst.users ? inst.users.name : 'Unknown'"></div>
                  <div class="text-xs text-gray-500" x-text="inst.users ? inst.users.email : (inst.user_id)"></div>
                </td>
                <td class="px-6 py-4">
                  <span class="badge badge-instructor" x-text="inst.divisions ? inst.divisions.code : '-'"></span>
                </td>
                <td class="px-6 py-4">
                  <div class="flex flex-col gap-1">
                    <span x-show="inst.teamleader_role" class="text-xs font-bold text-gold flex items-center gap-1">
                      <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/></svg>
                      Team Leader
                    </span>
                    <span class="text-xs text-gray-500" x-text="inst.status"></span>
                  </div>
                </td>
                <td class="px-6 py-4 text-xs text-gray-600">
                   <div x-show="inst.bay">Bay: <span class="font-medium" x-text="inst.bay"></span></div>
                   <div x-show="inst.floor">Floor: <span class="font-medium" x-text="inst.floor"></span></div>
                </td>
                <td class="px-6 py-4 text-right">
                  <button @click="openModal('edit', { ...inst, role: 'instructor', email: inst.users?.email, name: inst.users?.name })" class="text-gray-400 hover:text-navy transition mx-1 font-medium text-xs uppercase tracking-wide">Edit</button>
                </td>
              </tr>
            </template>
            <tr x-show="filteredInstructors.length === 0">
              <td colspan="5" class="px-6 py-12 text-center text-gray-500 italic">No instructors found.</td>
            </tr>
          </tbody>
        </table>
       </div>
    </div>

    <!-- Students Tab -->
    <div x-show="!loading && activeTab === 'students'" class="space-y-6 animate-fade-in">
       <!-- Sync Section -->
       <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex flex-col sm:flex-row justify-between items-center gap-4">
          <div>
            <h2 class="text-lg font-bold text-navy flex items-center gap-2">
               <svg class="w-5 h-5 text-gold" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l9-5-9-5-9 5 9 5z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l9-5-9-5-9 5 9 5zm0 0l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14zm-4 6v-7.5l4-2.222"/></svg>
               Sync from Master Sheet
            </h2>
            <p class="text-sm text-gray-500 mt-1">Sync students from Google Sheet (Student, Active).</p>
          </div>
          <div class="flex items-center gap-3">
             <div x-show="syncResult" class="text-xs font-medium px-3 py-1.5 rounded-lg" 
                  :class="syncResult && syncResult.success ? 'bg-green-50 text-green-700' : 'bg-red-50 text-red-700'">
                <span x-text="syncResultMessage"></span>
             </div>
             <button @click="syncStudents" :disabled="syncing" 
                     class="bg-navy hover:bg-navy-light text-white px-4 py-2 rounded-lg text-sm font-medium transition shadow-sm flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
               <svg class="w-4 h-4" :class="{'animate-spin': syncing}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
               <span x-text="syncing ? 'Syncing...' : 'Sync Students'"></span>
             </button>
          </div>
       </div>

       <!-- Table -->
       <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
        <table class="w-full text-left border-collapse">
          <thead>
            <tr class="bg-gray-50 border-b border-gray-200 text-xs text-gray-500 uppercase tracking-wider font-semibold">
              <th class="px-6 py-4">Name / ID / Email</th>
              <th class="px-6 py-4">Location</th>
              <th class="px-6 py-4">Year</th>
              <th class="px-6 py-4">Status</th>
              <th class="px-6 py-4 text-right">Actions</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-100">
            <template x-for="student in filteredStudents" :key="student.student_id">
              <tr class="hover:bg-gray-50/50 transition">
                <td class="px-6 py-4">
                  <div class="font-medium text-navy" x-text="student.users ? student.users.name : 'Unknown'"></div>
                  <div class="text-xs text-navy-light font-mono" x-text="student.academic_id"></div>
                  <div class="text-xs text-gray-500" x-text="student.users ? student.users.email : (student.user_id)"></div>
                </td>
                <td class="px-6 py-4">
                   <div class="flex flex-col gap-1">
                      <span class="text-xs text-gray-600">Floor: <span class="font-medium" x-text="student.floors ? student.floors.label : '-'"></span></span>
                      <span class="text-xs text-gray-600">Unit: <span class="font-medium" x-text="student.unit_id || '-'"></span></span>
                   </div>
                </td>
                <td class="px-6 py-4 text-sm text-gray-600" x-text="student.first_clinic_year"></td>
                <td class="px-6 py-4">
                  <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium"
                        :class="student.status === 'active' ? 'bg-emerald-50 text-emerald-700' : 'bg-gray-100 text-gray-600'">
                    <span class="w-1.5 h-1.5 rounded-full" :class="student.status === 'active' ? 'bg-emerald-500' : 'bg-gray-400'"></span>
                    <span x-text="student.status"></span>
                  </span>
                </td>
                <td class="px-6 py-4 text-right">
                  <button @click="openModal('edit', { ...student, role: 'student', email: student.users?.email, name: student.users?.name })" class="text-gray-400 hover:text-navy transition mx-1 font-medium text-xs uppercase tracking-wide">Edit</button>
                </td>
              </tr>
            </template>
            <tr x-show="filteredStudents.length === 0">
              <td colspan="5" class="px-6 py-12 text-center text-gray-500 italic">No students found.</td>
            </tr>
          </tbody>
        </table>
       </div>
    </div>

    <!-- Users Table -->
    <div x-show="!loading && activeTab === 'users'" class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden animate-fade-in">
      <table class="w-full text-left border-collapse">
        <thead>
          <tr class="bg-gray-50 border-b border-gray-200 text-xs text-gray-500 uppercase tracking-wider font-semibold">
            <th class="px-6 py-4">Name / Email</th>
            <th class="px-6 py-4">Role</th>
            <th class="px-6 py-4">Status</th>
            <th class="px-6 py-4 text-right">Actions</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-100">
          <template x-for="user in filteredUsers" :key="user.user_id">
            <tr class="hover:bg-gray-50/50 transition">
              <td class="px-6 py-4">
                <div class="font-medium text-navy" x-text="user.name || 'Unknown'"></div>
                <div class="text-xs text-gray-500" x-text="user.email"></div>
              </td>
              <td class="px-6 py-4">
                <span class="badge" 
                      :class="{ 'badge-admin': user.role==='admin', 'badge-instructor': user.role==='instructor', 'badge-student': user.role==='student' }"
                      x-text="user.role"></span>
              </td>
              <td class="px-6 py-4">
                <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium"
                      :class="user.status === 'active' ? 'bg-emerald-50 text-emerald-700' : 'bg-gray-100 text-gray-600'">
                  <span class="w-1.5 h-1.5 rounded-full" :class="user.status === 'active' ? 'bg-emerald-500' : 'bg-gray-400'"></span>
                  <span x-text="user.status"></span>
                </span>
              </td>
              <td class="px-6 py-4 text-right">
                <button @click="openModal('edit', user)" class="text-gray-400 hover:text-navy transition mx-1 font-medium text-xs uppercase tracking-wide">Edit</button>
                <button x-show="user.role !== 'admin'" 
                        @click="deleteUser(user, $event)" 
                        class="text-red-300 hover:text-red-600 transition mx-1"
                        title="Delete User">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                </button>
              </td>
            </tr>
          </template>
          <tr x-show="filteredUsers.length === 0">
            <td colspan="4" class="px-6 py-12 text-center text-gray-500 italic">No users found.</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Divisions Table -->
    <div x-show="!loading && activeTab === 'divisions'" class="space-y-4 animate-fade-in">
       <div class="flex justify-between items-center bg-white p-4 rounded-xl shadow-sm border border-gray-200">
         <h2 class="text-lg font-bold text-gray-800">Divisions</h2>
         <button @click="openModal('create')" class="bg-navy text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-navy-light transition flex items-center gap-2">
           <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
           Add Division
         </button>
       </div>
       <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-x-auto">
      <table class="w-full text-left border-collapse">
        <thead>
          <tr class="bg-gray-50 border-b border-gray-200 text-xs text-gray-500 uppercase tracking-wider font-semibold">
            <th class="px-6 py-4">Code</th>
            <th class="px-6 py-4">Name</th>
            <th class="px-6 py-4">Clinic</th>
            <th class="px-6 py-4">Non-Main-Clinic-Patient</th>
            <th class="px-6 py-4 text-right">Actions</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-100">
          <template x-for="div in filteredDivisions" :key="div.division_id">
            <tr class="hover:bg-gray-50/50 transition">
              <td class="px-6 py-4 font-mono text-xs text-navy font-bold" x-text="div.code"></td>
              <td class="px-6 py-4 text-sm text-gray-700" x-text="div.name"></td>
              <td class="px-6 py-4 text-sm text-gray-700">
                <span class="badge" :class="div.clinic === 'main' ? 'badge-admin' : (div.clinic === 'rotate' ? 'badge-instructor' : 'bg-gray-100 text-gray-600')" x-text="div.clinic"></span>
              </td>
              <td class="px-6 py-4 text-sm text-center">
                <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium"
                      :class="div.have_non_main_patient_requirements ? 'bg-emerald-100 text-emerald-800' : 'bg-gray-100 text-gray-800'">
                  <span x-text="div.have_non_main_patient_requirements ? 'Yes' : 'No'"></span>
                </span>
              </td>
              <td class="px-6 py-4 text-right">
                <button @click="openModal('edit', div)" class="text-gray-400 hover:text-navy transition mx-1 font-medium text-xs uppercase tracking-wide">Edit</button>
              </td>
            </tr>
          </template>
          <tr x-show="filteredDivisions.length === 0">
            <td colspan="5" class="px-6 py-12 text-center text-gray-500 italic">No divisions found.</td>
          </tr>
        </tbody>
      </table>
    </div>
    </div>

    <!-- Floors Tab Content -->
    <div x-show="!loading && activeTab === 'floors'" class="space-y-4 animate-fade-in">
       <div class="flex justify-between items-center bg-white p-4 rounded-xl shadow-sm border border-gray-200">
         <h2 class="text-lg font-bold text-gray-800">Floors</h2>
         <button @click="openModal('create')" class="bg-navy text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-navy-light transition flex items-center gap-2">
           <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
           Add Floor
         </button>
       </div>
       <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-x-auto">
       <table class="w-full text-left border-collapse">
         <thead class="bg-gray-50 border-b border-gray-200 text-xs text-gray-500 uppercase tracking-wider font-semibold">
           <tr>
             <th class="px-6 py-4">Label</th>
             <th class="px-6 py-4 text-right">Actions</th>
           </tr>
         </thead>
         <tbody class="divide-y divide-gray-100">
           <template x-for="floor in floors" :key="floor.floor_id">
             <tr class="hover:bg-gray-50 transition-colors">
               <td class="px-6 py-4 whitespace-nowrap">
                 <span class="text-sm font-medium text-gray-900" x-text="floor.label"></span>
               </td>
               <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                 <button @click="editFloor(floor)" class="text-gray-400 hover:text-navy transition mx-1 font-medium text-xs uppercase tracking-wide">Edit</button>
               </td>
             </tr>
           </template>
           <tr x-show="floors.length === 0">
             <td colspan="2" class="px-6 py-8 text-center text-gray-500">No floors found.</td>
           </tr>
         </tbody>
       </table>
    </div>
    </div>

    <!-- Treatment Phases Tab Content -->
    <div x-show="!loading && activeTab === 'phases'" class="space-y-4 animate-fade-in">
       <div class="flex justify-between items-center bg-white p-4 rounded-xl shadow-sm border border-gray-200">
         <h2 class="text-lg font-bold text-gray-800">Treatment Phases</h2>
         <button @click="openModal('create')" class="bg-navy text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-navy-light transition flex items-center gap-2">
           <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
           Add Phase
         </button>
       </div>
       <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-x-auto">
       <table class="w-full text-left border-collapse">
         <thead class="bg-gray-50 border-b border-gray-200 text-xs text-gray-500 uppercase tracking-wider font-semibold">
           <tr>
             <th class="px-6 py-4">Order</th>
             <th class="px-6 py-4">Phase Name</th>
             <th class="px-6 py-4 text-right">Actions</th>
           </tr>
         </thead>
         <tbody class="divide-y divide-gray-100">
           <template x-for="phase in filteredPhases" :key="phase.phase_id">
             <tr class="hover:bg-gray-50 transition-colors">
               <td class="px-6 py-4 whitespace-nowrap">
                 <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-navy/10 text-navy text-sm font-bold" x-text="phase.phase_order"></span>
               </td>
               <td class="px-6 py-4 whitespace-nowrap">
                 <span class="text-sm font-medium text-gray-900" x-text="phase.phase_name"></span>
               </td>
               <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                 <button @click="openModal('edit', phase)" class="text-gray-400 hover:text-navy transition mx-1 font-medium text-xs uppercase tracking-wide">Edit</button>
                 <button @click="deleteTreatmentPhase(phase, $event)" 
                         class="text-red-300 hover:text-red-600 transition mx-1"
                         title="Delete Phase">
                   <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                 </button>
               </td>
             </tr>
           </template>
           <tr x-show="filteredPhases.length === 0">
             <td colspan="3" class="px-6 py-8 text-center text-gray-500">No treatment phases found.</td>
           </tr>
         </tbody>
       </table>
    </div>
    </div>

    <!-- Treatment Catalog Tab Content -->
    <div x-show="!loading && activeTab === 'catalog'" class="space-y-4 animate-fade-in">
       <div class="flex justify-between items-center bg-white p-4 rounded-xl shadow-sm border border-gray-200">
         <h2 class="text-lg font-bold text-gray-800">Treatment Catalog</h2>
         <button @click="openModal('create')" class="bg-navy text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-navy-light transition flex items-center gap-2">
           <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
           Add Treatment
         </button>
       </div>
       <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-x-auto">
       <table class="w-full text-left border-collapse">
         <thead class="bg-gray-50 border-b border-gray-200 text-xs text-gray-500 uppercase tracking-wider font-semibold">
           <tr>
             <th class="px-6 py-4">Division</th>
             <th class="px-6 py-4">Treatment Name</th>
             <th class="px-6 py-4 text-right">Actions</th>
           </tr>
         </thead>
         <tbody class="divide-y divide-gray-100">
           <template x-for="item in filteredCatalog" :key="item.treatment_id">
             <tr class="hover:bg-gray-50 transition-colors">
               <td class="px-6 py-4 whitespace-nowrap">
                 <span class="badge badge-instructor" x-text="item.divisions ? item.divisions.name : '-'"></span>
               </td>
               <td class="px-6 py-4 whitespace-nowrap">
                 <span class="text-sm font-medium text-gray-900" x-text="item.treatment_name"></span>
               </td>
               <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                 <button @click="openModal('edit', item)" class="text-gray-400 hover:text-navy transition mx-1 font-medium text-xs uppercase tracking-wide">Edit</button>
                 <button @click="deleteTreatmentCatalog(item, $event)" 
                         class="text-red-300 hover:text-red-600 transition mx-1"
                         title="Delete Treatment">
                   <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                 </button>
               </td>
             </tr>
           </template>
           <tr x-show="filteredCatalog.length === 0">
             <td colspan="3" class="px-6 py-8 text-center text-gray-500">No treatment catalog entries found.</td>
           </tr>
         </tbody>
       </table>
    </div>
    </div>

    <!-- Case Types Tab Content -->
    <div x-show="!loading && activeTab === 'caseTypes'" class="space-y-4 animate-fade-in">
       <div class="flex justify-between items-center bg-white p-4 rounded-xl shadow-sm border border-gray-200">
         <h2 class="text-lg font-bold text-gray-800">Case Types</h2>
         <button @click="openModal('create')" class="bg-navy text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-navy-light transition flex items-center gap-2">
           <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
           Add Case Type
         </button>
       </div>
       <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-x-auto">
       <table class="w-full text-left border-collapse">
         <thead class="bg-gray-50 border-b border-gray-200 text-xs text-gray-500 uppercase tracking-wider font-semibold">
           <tr>
             <th class="px-6 py-4">Case Type Name</th>
             <th class="px-6 py-4 text-right">Actions</th>
           </tr>
         </thead>
         <tbody class="divide-y divide-gray-100">
           <template x-for="item in filteredCaseTypes" :key="item.id">
             <tr class="hover:bg-gray-50 transition-colors">
               <td class="px-6 py-4 whitespace-nowrap">
                 <span class="text-sm font-medium text-gray-900" x-text="item.type_of_case"></span>
               </td>
               <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                 <button @click="openModal('edit', item)" class="text-gray-400 hover:text-navy transition mx-1 font-medium text-xs uppercase tracking-wide">Edit</button>
                 <button @click="deleteTypeOfCase(item, $event)" 
                         class="text-red-300 hover:text-red-600 transition mx-1"
                         title="Delete Case Type">
                   <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                 </button>
               </td>
             </tr>
           </template>
           <tr x-show="filteredCaseTypes.length === 0">
             <td colspan="2" class="px-6 py-8 text-center text-gray-500">No case types found.</td>
           </tr>
         </tbody>
       </table>
    </div>
    </div>

    <!-- Treatment Steps Tab Content -->
    <div x-show="!loading && activeTab === 'steps'" class="space-y-4 animate-fade-in">
       <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 bg-white p-4 rounded-xl shadow-sm border border-gray-200">
         <h2 class="text-lg font-bold text-gray-800">Treatment Steps</h2>
         <div class="flex flex-wrap items-center gap-3">
           <!-- Division Filter -->
           <select x-model="stepsFilterDivision" @change="stepsFilterTreatment = ''; filterSteps();"
                   class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-navy focus:border-transparent bg-white">
             <option value="">All Divisions</option>
             <template x-for="div in divisions" :key="div.division_id">
               <option :value="div.division_id" x-text="div.name"></option>
             </template>
           </select>
           <!-- Treatment Filter (filtered by selected division) -->
           <select x-model="stepsFilterTreatment" @change="filterSteps()"
                   class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-navy focus:border-transparent bg-white">
             <option value="">All Treatments</option>
             <template x-for="item in catalog.filter(c => !stepsFilterDivision || c.division_id === stepsFilterDivision)" :key="item.treatment_id">
               <option :value="item.treatment_id" x-text="item.treatment_name"></option>
             </template>
           </select>
           <button @click="openModal('create')" class="bg-navy text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-navy-light transition flex items-center gap-2">
             <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
             Add Step
           </button>
         </div>
       </div>
       <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-x-auto">
       <table class="w-full text-left border-collapse">
         <thead class="bg-gray-50 border-b border-gray-200 text-xs text-gray-500 uppercase tracking-wider font-semibold">
           <tr>
             <th class="px-6 py-4">Division</th>
             <th class="px-6 py-4">Treatment</th>
             <th class="px-6 py-4">Order</th>
             <th class="px-6 py-4">Step Name</th>
             <th class="px-6 py-4 text-right">Actions</th>
           </tr>
         </thead>
         <tbody class="divide-y divide-gray-100">
           <template x-for="step in filteredSteps" :key="step.step_id">
             <tr class="hover:bg-gray-50 transition-colors">
               <td class="px-6 py-4 whitespace-nowrap">
                 <span class="badge badge-instructor" x-text="step.treatment_catalog && step.treatment_catalog.divisions ? step.treatment_catalog.divisions.name : '-'"></span>
               </td>
               <td class="px-6 py-4 whitespace-nowrap">
                 <span class="badge badge-instructor" x-text="step.treatment_catalog ? step.treatment_catalog.treatment_name : '-'"></span>
               </td>
               <td class="px-6 py-4 whitespace-nowrap">
                 <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-navy/10 text-navy text-sm font-bold" x-text="step.step_order"></span>
               </td>
               <td class="px-6 py-4 whitespace-nowrap">
                 <span class="text-sm font-medium text-gray-900" x-text="step.step_name"></span>
               </td>
               <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                 <button @click="openModal('edit', step)" class="text-gray-400 hover:text-navy transition mx-1 font-medium text-xs uppercase tracking-wide">Edit</button>
                 <button @click="deleteTreatmentStep(step, $event)" 
                         class="text-red-300 hover:text-red-600 transition mx-1"
                         title="Delete Step">
                   <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                 </button>
               </td>
             </tr>
           </template>
           <tr x-show="filteredSteps.length === 0">
             <td colspan="5" class="px-6 py-8 text-center text-gray-500">No treatment steps found.</td>
           </tr>
         </tbody>
       </table>
    </div>
    </div>

    <div x-show="!loading && activeTab === 'requirements'" class="space-y-4 animate-fade-in">
       <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 bg-white p-4 rounded-xl shadow-sm border border-gray-200">
         <h2 class="text-lg font-bold text-gray-800">Requirement List</h2>
         <div class="flex flex-wrap items-center gap-3">
           <!-- Division Filter -->
           <select x-model="requirementsFilterDivision" @change="filterRequirements()"
                   class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-navy focus:border-transparent bg-white">
             <option value="">All Divisions</option>
             <template x-for="div in divisions" :key="div.division_id">
               <option :value="div.division_id" x-text="div.name"></option>
             </template>
           </select>
           <button @click="openModal('create')" class="bg-navy text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-navy-light transition flex items-center gap-2">
             <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
             Add Requirement
           </button>
         </div>
       </div>
       <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-x-auto">
       <table class="w-full text-left border-collapse">
         <thead class="bg-gray-50 border-b border-gray-200 text-xs text-gray-500 uppercase tracking-wider font-semibold">
           <tr>
             <th class="px-6 py-4">Division</th>
             <th class="px-6 py-4">Requirement Type</th>
             <th class="px-6 py-4">CDA Type</th>
             <th class="px-6 py-4">Min RSU (Unit)</th>
              <th class="px-6 py-4">Min CDA (Unit)</th>
              <th class="px-6 py-4 text-center">Pt. Tx</th>
              <th class="px-6 py-4 text-center">Non-MC</th>
              <th class="px-6 py-4 text-center">Selectable</th>
              <th class="px-6 py-4 text-center">Exam</th>
              <th class="px-6 py-4 text-center">Aggregation</th>
              <th class="px-6 py-4 text-right">Actions</th>
           </tr>
         </thead>
         <tbody class="divide-y divide-gray-100">
           <template x-for="req in filteredRequirements" :key="req.requirement_id">
             <tr class="hover:bg-gray-50 transition-colors">
               <td class="px-6 py-4 whitespace-nowrap">
                 <span class="badge badge-instructor" x-text="req.divisions ? req.divisions.name : '-'"></span>
               </td>
               <td class="px-6 py-4 whitespace-nowrap">
                 <span class="text-sm font-medium text-gray-900" x-text="req.requirement_type"></span>
               </td>
               <td class="px-6 py-4 whitespace-nowrap">
                 <span class="text-sm text-gray-700" x-text="req.cda_requirement_type || '-'"></span>
               </td>
               <td class="px-6 py-4 whitespace-nowrap">
                 <span class="text-sm text-gray-700" x-text="req.minimum_rsu + ' ' + (req.rsu_unit || '')"></span>
               </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <span class="text-sm text-gray-700" x-text="req.minimum_cda + ' ' + (req.cda_unit || '')"></span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-center">
                  <span x-show="req.is_patient_treatment" class="text-emerald-500">
                    <svg class="w-5 h-5 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                  </span>
                  <span x-show="!req.is_patient_treatment" class="text-gray-300">
                    <svg class="w-5 h-5 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                  </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-center">
                  <span x-show="req.non_mc_pateint_req" class="text-emerald-500">
                    <svg class="w-5 h-5 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                  </span>
                  <span x-show="!req.non_mc_pateint_req" class="text-gray-300">
                    <svg class="w-5 h-5 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                  </span>
                </td>
                <!-- is_selectable -->
                <td class="px-6 py-4 whitespace-nowrap text-center">
                  <span x-show="req.is_selectable !== false" class="text-emerald-500" title="Appears in dropdown">
                    <svg class="w-5 h-5 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                  </span>
                  <span x-show="req.is_selectable === false" class="text-amber-400 font-bold text-xs" title="Computed  hidden from dropdown">Derived</span>
                </td>
                <!-- is_exam -->
                <td class="px-6 py-4 whitespace-nowrap text-center">
                  <span x-show="req.is_exam" class="text-blue-500 font-bold text-xs">Exam</span>
                  <span x-show="!req.is_exam" class="text-gray-300 text-xs"></span>
                </td>
                <!-- aggregation_config -->
                <td class="px-6 py-4 whitespace-nowrap text-center">
                  <span x-show="!req.aggregation_config" class="text-gray-400 text-xs">sum</span>
                  <span x-show="req.aggregation_config"
                        class="inline-block px-2 py-0.5 rounded text-[10px] font-mono bg-indigo-50 text-indigo-700 border border-indigo-100"
                        x-text="req.aggregation_config ? (req.aggregation_config.type || 'sum') : 'sum'"></span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                 <button @click="openModal('edit', req)" class="text-gray-400 hover:text-navy transition mx-1 font-medium text-xs uppercase tracking-wide">Edit</button>
                 <button @click="deleteRequirement(req, $event)" 
                         class="text-red-300 hover:text-red-600 transition mx-1"
                         title="Delete Requirement">
                   <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                 </button>
               </td>
             </tr>
           </template>
           <tr x-show="filteredRequirements.length === 0">
             <td colspan="7" class="px-6 py-8 text-center text-gray-500">No requirements found.</td>
           </tr>
         </tbody>
       </table>
    </div>
    </div>

       <!-- Patients Tab Content -->
      <div x-show="activeTab === 'patients'" class="space-y-6">
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
          <h2 class="text-xl font-bold text-gray-800 mb-4">External Patient Sync</h2>
          <p class="text-gray-600 mb-6">
            Sync patient data from the configured Google Sheet (<code>PATIENT_SHEET_ID</code>). 
            This will update existing patients (by HN) and create new ones.
          </p>
          
          <div class="flex items-center space-x-4">
             <button @click="syncPatients" :disabled="syncing" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition-colors flex items-center disabled:opacity-50 disabled:cursor-not-allowed">
               <i class="fas fa-sync-alt mr-2" :class="{'animate-spin': syncing}"></i>
               <span x-text="syncing ? 'Syncing...' : 'Sync Patients Now'"></span>
             </button>
             
             <div x-show="syncResult" class="text-sm" :class="{'text-green-600': syncResult && syncResult.success, 'text-red-600': syncResult && !syncResult.success}">
                <span x-text="syncResultMessage"></span>
             </div>
          </div>
        </div>
      </div>

  </main>

  <!-- Modal -->
  <div x-show="modalOpen" class="fixed inset-0 z-50 flex items-center justify-center p-4" style="display: none;">
    <!-- Backdrop -->
    <div class="fixed inset-0 bg-navy/20 backdrop-blur-sm transition-opacity" @click="closeModal()"></div>
    
    <!-- Panel -->
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg max-h-[90vh] overflow-y-auto p-6 relative z-10 animate-fade-in">
      <h2 class="text-xl font-bold text-navy mb-6" x-text="(mode === 'create' ? 'Add ' : 'Edit ') + (activeTab === 'users' ? 'User' : (activeTab === 'instructors' ? 'Instructor' : (activeTab === 'students' ? 'Student' : (activeTab === 'divisions' ? 'Division' : (activeTab === 'floors' ? 'Floor' : (activeTab === 'phases' ? 'Treatment Phase' : (activeTab === 'catalog' ? 'Treatment' : (activeTab === 'caseTypes' ? 'Case Type' : (activeTab === 'steps' ? 'Treatment Step' : 'Requirement'))))))))))"></h2>
      
      <!-- User Form -->
      <div x-show="['users', 'instructors', 'students'].includes(activeTab)" class="space-y-4">
        <div>
          <label class="block text-xs font-medium text-gray-500 uppercase mb-1">Email</label>
          <input type="email" x-model="userForm.email" :disabled="mode === 'edit'"
                 class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-navy focus:border-transparent disabled:bg-gray-50 disabled:text-gray-500">
        </div>
        
        <div>
          <label class="block text-xs font-medium text-gray-500 uppercase mb-1">Full Name</label>
          <input type="text" x-model="userForm.name"
                 class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-navy">
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-xs font-medium text-gray-500 uppercase mb-1">Role</label>
            <select x-model="userForm.role"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-navy disabled:bg-gray-50">
              <option value="student">Student</option>
              <option value="instructor">Instructor</option>
              <option value="admin">Admin</option>
            </select>
          </div>
          <div>
            <label class="block text-xs font-medium text-gray-500 uppercase mb-1">Status</label>
            <select x-model="userForm.status"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-navy">
              <option value="active">Active</option>
              <option value="inactive">Inactive</option>
            </select>
          </div>
        </div>

        <div x-show="userForm.role === 'student'" class="pt-2 border-t border-gray-100 mt-2">
          <p class="text-xs text-navy font-semibold mb-3">Student Details</p>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-xs font-medium text-gray-500 mb-1">First Clinic Year</label>
              <input type="number" x-model="userForm.first_clinic_year" 
                     class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-navy">
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-500 uppercase mb-1">Academic ID</label>
              <input type="text" x-model="userForm.academic_id"
                     class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-navy"
                     placeholder="e.g. 12345678">
            </div>
             <div>
              <label class="block text-xs font-medium text-gray-500 uppercase mb-1">Unit ID</label>
              <input type="text" x-model="userForm.unit_id"
                     class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-navy"
                     placeholder="e.g. U-123">
            </div>
             <div>
              <label class="block text-xs font-medium text-gray-500 uppercase mb-1">Floor</label>
              <select x-model="userForm.floor_id"
                      class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-navy">
                <option value="">(None)</option>
                <template x-for="floor in floors" :key="floor.floor_id">
                  <option :value="floor.floor_id" x-text="floor.label"></option>
                </template>
              </select>
            </div>
          </div>
          
           <div class="grid grid-cols-2 gap-4 mt-3">
             <div>
              <label class="block text-xs font-medium text-gray-500 uppercase mb-1">1st Team Leader</label>
              <select x-model="userForm.team_leader_1_id"
                      class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-navy">
                <option value="">(None)</option>
                <template x-for="tl in teamLeaders" :key="tl.instructor_id || tl.user_id">
                  <option :value="tl.instructor_id" x-text="tl.name"></option>
                </template>
              </select>
            </div>
             <div>
              <label class="block text-xs font-medium text-gray-500 uppercase mb-1">2nd Team Leader</label>
              <select x-model="userForm.team_leader_2_id"
                      class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-navy">
                <option value="">(None)</option>
                <template x-for="tl in teamLeaders" :key="tl.instructor_id || tl.user_id">
                  <option :value="tl.instructor_id" x-text="tl.name"></option>
                </template>
              </select>
            </div>
           </div>

           <p class="text-xs text-navy font-semibold mb-2 mt-4">Division Instructors</p>
           <div class="grid grid-cols-3 gap-3">
             <div>
               <label class="block text-xs font-medium text-gray-500 mb-1">Operative</label>
               <select x-model="userForm.oper_instructor_id" class="w-full px-2 py-1.5 border border-gray-300 rounded-lg text-xs focus:ring-2 focus:ring-navy">
                 <option value="">(None)</option>
                 <template x-for="inst in instructorsByDivCode('OPER')" :key="inst.instructor_id">
                   <option :value="inst.instructor_id" x-text="inst.name"></option>
                 </template>
               </select>
             </div>
             <div>
               <label class="block text-xs font-medium text-gray-500 mb-1">Endodontics</label>
               <select x-model="userForm.endo_instructor_id" class="w-full px-2 py-1.5 border border-gray-300 rounded-lg text-xs focus:ring-2 focus:ring-navy">
                 <option value="">(None)</option>
                 <template x-for="inst in instructorsByDivCode('ENDO')" :key="inst.instructor_id">
                   <option :value="inst.instructor_id" x-text="inst.name"></option>
                 </template>
               </select>
             </div>
             <div>
               <label class="block text-xs font-medium text-gray-500 mb-1">Periodontics</label>
               <select x-model="userForm.perio_instructor_id" class="w-full px-2 py-1.5 border border-gray-300 rounded-lg text-xs focus:ring-2 focus:ring-navy">
                 <option value="">(None)</option>
                 <template x-for="inst in instructorsByDivCode('PERIO')" :key="inst.instructor_id">
                   <option :value="inst.instructor_id" x-text="inst.name"></option>
                 </template>
               </select>
             </div>
             <div>
               <label class="block text-xs font-medium text-gray-500 mb-1">Prosthodontics</label>
               <select x-model="userForm.prosth_instructor_id" class="w-full px-2 py-1.5 border border-gray-300 rounded-lg text-xs focus:ring-2 focus:ring-navy">
                 <option value="">(None)</option>
                 <template x-for="inst in instructorsByDivCode('PROSTH')" :key="inst.instructor_id">
                   <option :value="inst.instructor_id" x-text="inst.name"></option>
                 </template>
               </select>
             </div>
             <div>
               <label class="block text-xs font-medium text-gray-500 mb-1">Oral Diagnosis</label>
               <select x-model="userForm.diag_instructor_id" class="w-full px-2 py-1.5 border border-gray-300 rounded-lg text-xs focus:ring-2 focus:ring-navy">
                 <option value="">(None)</option>
                 <template x-for="inst in instructorsByDivCode('DIAG')" :key="inst.instructor_id">
                   <option :value="inst.instructor_id" x-text="inst.name"></option>
                 </template>
               </select>
             </div>
             <div>
               <label class="block text-xs font-medium text-gray-500 mb-1">Radiology</label>
               <select x-model="userForm.radio_instructor_id" class="w-full px-2 py-1.5 border border-gray-300 rounded-lg text-xs focus:ring-2 focus:ring-navy">
                 <option value="">(None)</option>
                 <template x-for="inst in instructorsByDivCode('RADIO')" :key="inst.instructor_id">
                   <option :value="inst.instructor_id" x-text="inst.name"></option>
                 </template>
               </select>
             </div>
             <div>
               <label class="block text-xs font-medium text-gray-500 mb-1">Oral Surgery</label>
               <select x-model="userForm.sur_instructor_id" class="w-full px-2 py-1.5 border border-gray-300 rounded-lg text-xs focus:ring-2 focus:ring-navy">
                 <option value="">(None)</option>
                 <template x-for="inst in instructorsByDivCode('SUR')" :key="inst.instructor_id">
                   <option :value="inst.instructor_id" x-text="inst.name"></option>
                 </template>
               </select>
             </div>
             <div>
               <label class="block text-xs font-medium text-gray-500 mb-1">Orthodontics</label>
               <select x-model="userForm.ortho_instructor_id" class="w-full px-2 py-1.5 border border-gray-300 rounded-lg text-xs focus:ring-2 focus:ring-navy">
                 <option value="">(None)</option>
                 <template x-for="inst in instructorsByDivCode('ORTHO')" :key="inst.instructor_id">
                   <option :value="inst.instructor_id" x-text="inst.name"></option>
                 </template>
               </select>
             </div>
             <div>
               <label class="block text-xs font-medium text-gray-500 mb-1">Pediatric</label>
               <select x-model="userForm.pedo_instructor_id" class="w-full px-2 py-1.5 border border-gray-300 rounded-lg text-xs focus:ring-2 focus:ring-navy">
                 <option value="">(None)</option>
                 <template x-for="inst in instructorsByDivCode('PEDO')" :key="inst.instructor_id">
                   <option :value="inst.instructor_id" x-text="inst.name"></option>
                 </template>
               </select>
             </div>
           </div>
        </div>

        <div x-show="userForm.role === 'instructor' || userForm.role === 'admin'" class="pt-2 border-t border-gray-100 mt-2">
          <p class="text-xs text-navy font-semibold mb-3">Instructor Details</p>
          
          <div class="grid grid-cols-2 gap-4 mb-3">
             <div>
              <label class="block text-xs font-medium text-gray-500 uppercase mb-1">Division</label>
              <select x-model="userForm.division_id" 
                      class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-navy">
                <option value="">(None)</option>
                <template x-for="div in divisions" :key="div.division_id">
                  <option :value="div.division_id" x-text="div.name"></option>
                </template>
              </select>
            </div>
            
             <div>
              <label class="block text-xs font-medium text-gray-500 uppercase mb-1">Floor</label>
              <select x-model="userForm.floor_id"
                      class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-navy">
                <option value="">(None)</option>
                <template x-for="floor in floors" :key="floor.floor_id">
                  <option :value="floor.floor_id" x-text="floor.label"></option>
                </template>
              </select>
            </div>
          </div>
          
          <div class="grid grid-cols-2 gap-4">
             <div>
              <label class="block text-xs font-medium text-gray-500 uppercase mb-1">Bay</label>
              <input type="text" x-model="userForm.bay" placeholder="e.g. A, AB" maxlength="2"
                     @input="userForm.bay = $event.target.value.toUpperCase().replace(/[^A-Z]/g, '')"
                     class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-navy">
            </div>
            <div class="flex items-center pt-5">
              <input type="checkbox" id="teamleader" x-model="userForm.teamleader_role" class="rounded text-navy focus:ring-navy w-4 h-4 text-navy">
              <label for="teamleader" class="text-sm text-gray-700 ml-2 select-none">Team Leader</label>
            </div>
          </div>
        </div>
      </div>


      <!-- Division Form -->
      <div x-show="activeTab === 'divisions'" class="space-y-4">
        <div>
          <label class="block text-xs font-medium text-gray-500 uppercase mb-1">Division Code</label>
          <input type="text" x-model="divForm.code" placeholder="e.g. OPER, ENDO"
                 class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-navy">
          <p class="text-xs text-gray-400 mt-1">Short identifier, unique.</p>
        </div>
        <div>
          <label class="block text-xs font-medium text-gray-500 uppercase mb-1">Division Name</label>
          <input type="text" x-model="divForm.name" placeholder="e.g. Operative Dentistry"
                 class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-navy">
        </div>
        <div>
          <label class="block text-xs font-medium text-gray-500 uppercase mb-1">Clinic Type</label>
          <select x-model="divForm.clinic"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-navy">
            <option value="N/A">N/A</option>
            <option value="main">Main Clinic</option>
            <option value="rotate">Rotation Control</option>
          </select>
        </div>
        <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg border border-gray-100">
          <input type="checkbox" x-model="divForm.have_non_main_patient_requirements" id="div_out_of_patient"
                 class="w-4 h-4 text-navy border-gray-300 rounded focus:ring-navy">
          <label for="div_out_of_patient" class="text-sm font-medium text-gray-700">Allow Non-Main-Clinic-Patient Requirements</label>
        </div>
      </div>

      <!-- Floor Form -->
      <div x-show="activeTab === 'floors'" class="space-y-4">
        <div>
          <label class="block text-xs font-medium text-gray-500 uppercase mb-1">Floor Label</label>
          <input type="text" x-model="floorForm.label" placeholder="e.g. 2nd Floor"
                 class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-navy">
        </div>
      </div>

      <!-- Treatment Phase Form -->
      <div x-show="activeTab === 'phases'" class="space-y-4">
        <div>
          <label class="block text-xs font-medium text-gray-500 uppercase mb-1">Phase Order</label>
          <input type="number" x-model="phaseForm.phase_order" placeholder="e.g. 1" min="1"
                 class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-navy">
          <p class="text-xs text-gray-400 mt-1">Numeric order for display sorting.</p>
        </div>
        <div>
          <label class="block text-xs font-medium text-gray-500 uppercase mb-1">Phase Name</label>
          <input type="text" x-model="phaseForm.phase_name" placeholder="e.g. Systemic Phase"
                 class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-navy">
        </div>
      </div>

      <!-- Treatment Catalog Form -->
      <div x-show="activeTab === 'catalog'" class="space-y-4">
        <div>
          <label class="block text-xs font-medium text-gray-500 uppercase mb-1">Division</label>
          <select x-model="catalogForm.division_id"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-navy">
            <option value="">(Select Division)</option>
            <template x-for="div in divisions" :key="div.division_id">
              <option :value="div.division_id" x-text="div.name"></option>
            </template>
          </select>
        </div>
        <div>
          <label class="block text-xs font-medium text-gray-500 uppercase mb-1">Treatment Name</label>
          <input type="text" x-model="catalogForm.treatment_name" placeholder="e.g. Composite Filling"
                 class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-navy">
        </div>
      </div>

      <!-- Treatment Step Form -->
      <div x-show="activeTab === 'steps'" class="space-y-4">
        <div>
          <label class="block text-xs font-medium text-gray-500 uppercase mb-1">Filter by Division</label>
          <select x-model="stepDivisionFilter"
                  @change="stepForm.treatment_id = ''"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-navy">
            <option value="">All Divisions</option>
            <template x-for="div in divisions" :key="div.division_id">
              <option :value="div.division_id" x-text="div.name"></option>
            </template>
          </select>
          <p class="text-xs text-gray-400 mt-1">Narrow down treatments by division.</p>
        </div>
        <div>
          <label class="block text-xs font-medium text-gray-500 uppercase mb-1">Treatment</label>
          <select x-model="stepForm.treatment_id"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-navy">
            <option value="">(Select Treatment)</option>
            <template x-for="t in catalogForStep" :key="t.treatment_id">
              <option :value="t.treatment_id" x-text="t.treatment_name"></option>
            </template>
          </select>
        </div>
        <div>
          <label class="block text-xs font-medium text-gray-500 uppercase mb-1">Step Order</label>
          <input type="number" x-model="stepForm.step_order" placeholder="e.g. 1" min="1"
                 class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-navy">
          <p class="text-xs text-gray-400 mt-1">Numeric order within the treatment.</p>
        </div>
        <div>
          <label class="block text-xs font-medium text-gray-500 uppercase mb-1">Step Name</label>
          <input type="text" x-model="stepForm.step_name" placeholder="e.g. Initial Assessment"
                 class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-navy">
        </div>
      </div>

      <div x-show="activeTab === 'requirements'" class="space-y-4">
        <div>
          <label class="block text-xs font-medium text-gray-500 uppercase mb-1">Division</label>
          <select x-model="reqForm.division_id"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-navy">
            <option value="">(Select Division)</option>
            <template x-for="div in divisions" :key="div.division_id">
              <option :value="div.division_id" x-text="div.name"></option>
            </template>
          </select>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-xs font-medium text-gray-500 uppercase mb-1">Requirement Type</label>
            <input type="text" x-model="reqForm.requirement_type" placeholder="e.g. Total Unit"
                   class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-navy">
          </div>
          <div>
            <label class="block text-xs font-medium text-gray-500 uppercase mb-1">CDA Requirement Type</label>
            <input type="text" x-model="reqForm.cda_requirement_type" placeholder="e.g. CDA 1"
                   class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-navy">
          </div>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-xs font-medium text-gray-500 uppercase mb-1">Min RSU</label>
            <input type="number" x-model="reqForm.minimum_rsu" placeholder="0" min="0" step="0.1"
                   class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-navy">
          </div>
          <div>
            <label class="block text-xs font-medium text-gray-500 uppercase mb-1">RSU Unit</label>
            <input type="text" x-model="reqForm.rsu_unit" placeholder="Case"
                   class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-navy">
          </div>
          <div>
            <label class="block text-xs font-medium text-gray-500 uppercase mb-1">Min CDA</label>
            <input type="number" x-model="reqForm.minimum_cda" placeholder="0" min="0" step="0.1"
                   class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-navy">
          </div>
          <div>
            <label class="block text-xs font-medium text-gray-500 uppercase mb-1">CDA Unit</label>
            <input type="text" x-model="reqForm.cda_unit" placeholder="Case"
                   class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-navy">
          </div>
          <div class="col-span-2 pt-2 flex flex-col space-y-2">
            <label class="flex items-center space-x-2 cursor-pointer">
              <input type="checkbox" x-model="reqForm.is_patient_treatment" class="rounded text-navy focus:ring-navy w-4 h-4 text-navy">
              <span class="text-sm text-gray-700">Patient Treatment</span>
            </label>
            <label class="flex items-center space-x-2 cursor-pointer">
              <input type="checkbox" x-model="reqForm.non_mc_pateint_req" class="rounded text-navy focus:ring-navy w-4 h-4 text-navy">
              <span class="text-sm text-gray-700">Non-Main-Clinic Patient Requirement</span>
            </label>
            <label class="flex items-center space-x-2 cursor-pointer">
              <input type="checkbox" x-model="reqForm.is_selectable" class="rounded text-navy focus:ring-navy w-4 h-4 text-navy">
              <span class="text-sm text-gray-700">Selectable in Treatment Plan <span class="text-gray-400 text-xs">(uncheck for computed/derived requirements)</span></span>
            </label>
            <label class="flex items-center space-x-2 cursor-pointer">
              <input type="checkbox" x-model="reqForm.is_exam" class="rounded text-navy focus:ring-navy w-4 h-4 text-navy">
              <span class="text-sm text-gray-700">Exam-type requirement <span class="text-gray-400 text-xs">(counts exam records, not sum of units)</span></span>
            </label>
          </div>
          <!-- Aggregation Config -->
          <div class="col-span-2">
            <label class="block text-xs font-medium text-gray-500 uppercase mb-1">
              Aggregation Config
              <span class="normal-case text-gray-400 font-normal ml-1">(JSON  leave blank for default sum)</span>
            </label>
            <textarea x-model="reqForm.aggregation_config" rows="3"
                      placeholder='e.g. {"type":"count_exam"} or {"type":"derived","source_ids":["uuid1"],"operation":"sum_both"}'
                      class="w-full px-3 py-2 border border-gray-300 rounded-lg text-xs font-mono focus:ring-2 focus:ring-navy resize-none"></textarea>
            <div class="mt-1 text-[10px] text-gray-400 space-y-0.5">
              <div><code class="bg-gray-100 px-1 rounded">null</code> or blank  sum rsu_units/cda_units from linked records (default)</div>
              <div><code class="bg-gray-100 px-1 rounded">{"type":"count"}</code>  count records (not sum)</div>
              <div><code class="bg-gray-100 px-1 rounded">{"type":"count_exam"}</code>  count exam records in division</div>
              <div><code class="bg-gray-100 px-1 rounded">{"type":"derived","source_ids":["uuid"],"operation":"sum_both"}</code>  aggregate from other requirements</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Case Type Form -->
      <div x-show="activeTab === 'caseTypes'" class="space-y-4">
        <div>
          <label class="block text-xs font-medium text-gray-500 uppercase mb-1">Case Type Name</label>
          <input type="text" x-model="caseTypeForm.type_of_case" placeholder="e.g. Case I: Complexity 1"
                 class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-navy">
        </div>
      </div>

      <!-- Error Message -->
      <div x-show="errorMsg" class="text-red-600 text-sm bg-red-50 p-3 rounded-lg flex items-start gap-2 mt-4">
        <svg class="w-4 h-4 mt-0.5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
        <span x-text="errorMsg"></span>
      </div>

      <!-- Actions -->
      <div class="mt-8 flex justify-end gap-3 pt-4 border-t border-gray-100">
        <button @click="closeModal()" class="px-4 py-2 text-sm text-gray-500 hover:text-gray-700 font-medium">Cancel</button>
        <button @click="saveData()" :disabled="saving"
                class="px-4 py-2 bg-navy text-white rounded-lg text-sm font-medium hover:bg-navy-light disabled:opacity-50 flex items-center gap-2 shadow-sm">
          <span x-show="saving" class="spinner w-3 h-3 border-2 border-white/30 border-t-white rounded-full animate-spin"></span>
          <span x-text="saving ? 'Saving...' : (mode === 'create' ? 'Create' : 'Save Changes')"></span>
        </button>
      </div>
    </div>
  </div>

  <!-- Warning/Error Modal -->
  <div x-show="warningOpen" class="fixed inset-0 z-[60] flex items-center justify-center p-4" style="display: none;">
    <div class="fixed inset-0 bg-navy/20 backdrop-blur-sm transition-opacity" @click="warningOpen = false"></div>
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6 relative z-10 animate-fade-in border-l-4"
         :class="warningType === 'error' ? 'border-red-500' : 'border-gold'">
      <div class="flex items-start gap-4">
        <div class="p-2 rounded-full shrink-0"
             :class="warningType === 'error' ? 'bg-red-100 text-red-500' : 'bg-gold/10 text-gold'">
          <!-- Error Icon -->
          <svg x-show="warningType === 'error'" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
          <!-- Warning Icon -->
          <svg x-show="warningType !== 'error'" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
        </div>
        <div>
          <h3 class="text-lg font-bold text-navy mb-2" x-text="warningType === 'error' ? 'Error' : 'Notice'"></h3>
          <p class="text-sm text-gray-600 whitespace-pre-line" x-text="warningMessage"></p>
        </div>
      </div>
      <div class="mt-6 flex justify-end">
        <button @click="warningOpen = false" 
                class="px-4 py-2 text-white rounded-lg text-sm font-medium transition shadow-sm"
                :class="warningType === 'error' ? 'bg-red-600 hover:bg-red-700' : 'bg-navy hover:bg-navy-light'">
          Acknowledge
        </button>
      </div>
    </div>
  </div>

  <!-- Confirmation Modal -->
  <div x-show="confirmOpen" class="fixed inset-0 z-[70] flex items-center justify-center p-4" style="display: none;">
    <div class="fixed inset-0 bg-navy/20 backdrop-blur-sm transition-opacity" @click="confirmOpen = false"></div>
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-sm p-6 relative z-10 animate-fade-in">
      <div class="text-center">
        <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
          <svg class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
          </svg>
        </div>
        <h3 class="text-lg font-bold text-navy mb-2">Confirm Action</h3>
        <p class="text-sm text-gray-500 mb-6" x-text="confirmMessage"></p>
        <div class="flex justify-center gap-3">
          <button @click="confirmOpen = false" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-200 transition">
            Cancel
          </button>
          <button @click="confirmAction()" class="px-4 py-2 bg-red-600 text-white rounded-lg text-sm font-medium hover:bg-red-700 transition shadow-sm">
            Confirm
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    function adminApp() {
      return {
        activeTab: 'users', // users | divisions | floors | phases | catalog | steps | requirements
        
        // Users Data
        users: [],
        filteredUsers: [],
        
        // Instructors Data (for TL dropdown)
        instructors: [],

        // Divisions Data
        divisions: [],
        filteredDivisions: [],

        // Floors Data
        floors: [],
        
        // Instructors Data
        instructors: [],
        filteredInstructors: [],

        // Students Data
        students: [],
        filteredStudents: [],

        // Treatment Phases Data
        phases: [],
        filteredPhases: [],

        // Treatment Catalog Data
        catalog: [],
        filteredCatalog: [],

        // Treatment Steps Data
        steps: [],
        filteredSteps: [],
        stepsFilterDivision: '',
        stepsFilterTreatment: '',

        // Requirements Data
        requirements: [],
        filteredRequirements: [],

        // Case Types Data
        caseTypes: [],
        filteredCaseTypes: [],
        
        search: '',
        loading: true,
        modalOpen: false,
        sidebarOpen: false, // Fix ReferenceError
        maintenanceMode: false,
        health: { source: '...', healthy: true }, // Added health state
        
        // Warning Modal State
        warningOpen: false,
        warningType: 'warning', // warning | error
        warningMessage: '',

        // Confirmation Modal State
        confirmOpen: false,
        confirmMessage: '',
        confirmCallback: null,

        mode: 'create', // create | edit
        saving: false,
        errorMsg: '',
        
        // User Form
        userForm: {
          user_id: null,
          email: '',
          name: '',
          role: 'student',
          academic_id: '', // Initialize
          status: 'active',
          first_clinic_year: new Date().getFullYear(),
          teamleader_role: false,
          floor_id: '',
          bay: '',
          oper_instructor_id: '',
          endo_instructor_id: '',
          perio_instructor_id: '',
          prosth_instructor_id: '',
          diag_instructor_id: '',
          radio_instructor_id: '',
          sur_instructor_id: '',
          ortho_instructor_id: '',
          pedo_instructor_id: ''
        },

        get teamLeaders() {
          // Filter instructors who are Team Leaders
          if (!this.instructors || this.instructors.length === 0) return [];
          
          return this.instructors
            .filter(i => i.teamleader_role)
            .map(i => {
               // Find name from users list
               const u = this.users.find(u => u.user_id === i.user_id);
               return {
                 instructor_id: i.instructor_id,
                 name: u ? u.name : 'Unknown (' + i.user_id + ')',
                 user_id: i.user_id
               };
            })
            .sort((a,b) => a.name.localeCompare(b.name));
        },

        instructorsByDivCode(code) {
          if (!this.instructors || this.instructors.length === 0) return [];
          return this.instructors
            .filter(i => i.divisions && i.divisions.code === code)
            .map(i => {
              const u = this.users.find(u => u.user_id === i.user_id);
              return {
                instructor_id: i.instructor_id,
                name: u ? u.name : 'Unknown (' + i.user_id + ')'
              };
            })
            .sort((a, b) => a.name.localeCompare(b.name));
        },

        // Division Form
        divForm: {
          division_id: null,
          code: '',
          name: '',
          clinic: 'N/A'
        },

        // Floor Form
        floorForm: {
          floor_id: null,
          label: ''
        },

        // Treatment Phase Form
        phaseForm: {
          phase_id: null,
          phase_order: '',
          phase_name: ''
        },

        // Treatment Catalog Form
        catalogForm: {
          treatment_id: null,
          division_id: '',
          treatment_name: ''
        },

        // Treatment Step Form
        stepForm: {
          step_id: null,
          treatment_id: '',
          step_order: '',
          step_name: ''
        },
        stepDivisionFilter: '',
        requirementsFilterDivision: '',

        get catalogForStep() {
          if (!this.stepDivisionFilter) return this.catalog;
          return this.catalog.filter(c => c.division_id === this.stepDivisionFilter);
        },

        // Requirement Form
        reqForm: {
          requirement_id: null,
          division_id: '',
          requirement_type: '',
          cda_requirement_type: '',
          minimum_rsu: '',
          minimum_cda: '',
          rsu_unit: '',
          cda_unit: '',
          is_patient_treatment: true
        },
        // Case Type Form
        caseTypeForm: {
          id: null,
          type_of_case: ''
        },

        // UI State
        activeTab: 'users',
        syncing: false,
        syncResult: null,
        syncResultMessage: '',
        
        init() {
          this.loadInitData();
          this.checkMaintenanceMode();
          this.checkSystemHealth();
          
          this.$watch('search', () => {
             if (this.activeTab === 'users') this.filterUsers();
             else if (this.activeTab === 'students') this.filterStudents();
             else if (this.activeTab === 'phases') this.filterPhases();
             else if (this.activeTab === 'catalog') this.filterCatalog();
             else if (this.activeTab === 'steps') this.filterSteps();
              else if (this.activeTab === 'caseTypes') this.filterTypeOfCases();
              else if (this.activeTab === 'requirements') this.filterRequirements();
           });
          
          this.$watch('users', () => this.filterUsers());
          this.$watch('students', () => this.filterStudents());
          this.$watch('divisions', () => this.filterDivisions());
          this.$watch('phases', () => this.filterPhases());
          this.$watch('catalog', () => this.filterCatalog());
          this.$watch('steps', () => this.filterSteps());
          this.$watch('requirements', () => this.filterRequirements());
          this.$watch('caseTypes', () => this.filterTypeOfCases());
        },

        syncPatients() {
          this.syncing = true;
          this.syncResult = null;
          this.syncResultMessage = 'Starting sync...';
          
          google.script.run
            .withSuccessHandler(res => {
              this.syncing = false;
              this.syncResult = res;
              if (res.success) {
                 this.syncResultMessage = `Success! Created: ${res.stats.created || 0}, Updated: ${res.stats.updated || 0}, Errors: ${res.stats.errors || 0}`;
                 if (res.warning) {
                   this.warningType = 'error';
                   this.warningMessage = "Completed with Fallback Warnings:\n" + res.warning;
                   this.warningOpen = true;
                 }
              } else {
                 this.syncResultMessage = `Failed: ${res.error}`;
                 this.warningType = 'error';
                 this.warningMessage = "Sync Failed:\n" + res.error;
                 this.warningOpen = true;
              }
            })
            .withFailureHandler(err => {
              this.syncing = false;
              this.syncResult = { success: false };
              this.syncResultMessage = `Error: ${err.message}`;
              this.warningType = 'error';
              this.warningMessage = "System Error:\n" + err.message;
              this.warningOpen = true;
            })
            .adminSyncPatients();
        },

        syncStudents() {
          this.syncing = true;
          this.syncResult = null;
          this.syncResultMessage = 'Starting sync...';
          google.script.run
            .withSuccessHandler(res => {
              this.syncing = false;
              this.syncResult = res;
              if (res.success) {
                this.syncResultMessage = `Processed: ${res.stats.processed}, Updated/Created: ${res.stats.updated}, Errors: ${res.stats.errors}`;
                if (res.stats.warnings.length > 0) {
                     this.warningType = 'warning';
                     this.warningMessage = "Sync Warnings:\n" + res.stats.warnings.join('\n');
                     this.warningOpen = true;
                }
                this.loadStudents(); // Refresh list
              } else {
                this.syncResultMessage = `Failed: ${res.error}`;
                this.warningType = 'error';
                this.warningMessage = "Sync Failed:\n" + res.error;
                this.warningOpen = true;
              }
            })
            .withFailureHandler(err => {
              this.syncing = false;
              this.syncResultMessage = `Error: ${err.message}`;
            })
            .adminSyncStudents();
        },
        
        syncInstructors() {
          this.syncing = true;
          this.syncResult = null;
          this.syncResultMessage = 'Starting sync...';

          google.script.run
            .withSuccessHandler(res => {
              this.syncing = false;
              this.syncResult = res;
              if (res.success) {
                 // Refresh list
                 this.loadInstructors();
                 this.syncResultMessage = `Success! Processed: ${res.stats.processed}, Updated: ${res.stats.updated}, Errors: ${res.stats.errors}`;
                 
                 if (res.stats.warnings && res.stats.warnings.length > 0) {
                    this.warningType = 'notice';
                    this.warningMessage = "Sync Warnings:\n" + res.stats.warnings.join('\n');
                    this.warningOpen = true;
                 }
              } else {
                 this.syncResultMessage = `Failed: ${res.error}`;
                 this.warningType = 'error';
                 this.warningMessage = "Sync Failed:\n" + res.error;
                 this.warningOpen = true;
              }
            })
            .withFailureHandler(err => {
              this.syncing = false;
              this.syncResult = { success: false };
              this.syncResultMessage = `Error: ${err.message}`;
              this.warningType = 'error';
              this.warningMessage = "System Error:\n" + err.message;
              this.warningOpen = true;
            })
            .adminSyncInstructors();
        },
        
        loadData() {
          this.loadUsers();
        },

        checkMaintenanceMode() {
           google.script.run
            .withSuccessHandler(mode => {
              this.maintenanceMode = mode;
            })
            .adminGetMaintenanceMode();
        },

        checkSystemHealth() {
           google.script.run
            .withSuccessHandler(res => {
              this.health = res;
            })
            .checkSystemHealth();
        },

        toggleMaintenance() {
           // Optimistic UI update handled by x-model, but let's confirm
           console.log("Toggling maintenance to:", this.maintenanceMode);
           google.script.run
            .withSuccessHandler(res => {
               if(res.success) {
                 this.maintenanceMode = res.mode;
                 console.log("Maintenance mode set to:", res.mode);
               }
            })
            .adminSetMaintenanceMode(this.maintenanceMode);
        },

        switchTab(tab) {
          this.activeTab = tab;
          this.search = ''; // Reset search logic on tab switch
          if (tab === 'users') this.filterUsers();
          else if (tab === 'students') this.filterStudents(); // Switch
          else if (tab === 'instructors') this.filterInstructors();
          else if (tab === 'divisions') this.filterDivisions();
          else if (tab === 'phases') this.filterPhases();
          else if (tab === 'catalog') this.filterCatalog();
          else if (tab === 'steps') this.filterSteps();
          else if (tab === 'requirements') this.filterRequirements();
          else if (tab === 'caseTypes') this.filterTypeOfCases();
        },

        // 
        //  Filter Logic
        // 
        
        filterUsers() {
          if (!this.users) return;
          if (!this.search) {
            this.filteredUsers = this.users;
            return;
          }
          const q = this.search.toLowerCase();
          this.filteredUsers = this.users.filter(u => 
            (u.name && u.name.toLowerCase().includes(q)) || 
            (u.email && u.email.toLowerCase().includes(q))
          );
        },

        filterStudents() {
          if (!this.students) return;
          if (!this.search) {
            this.filteredStudents = this.students;
            return;
          }
          const q = this.search.toLowerCase();
          this.filteredStudents = this.students.filter(s => 
            (s.academic_id && s.academic_id.toLowerCase().includes(q)) || 
            (s.users && s.users.name && s.users.name.toLowerCase().includes(q)) ||
            (s.users && s.users.email && s.users.email.toLowerCase().includes(q))
          );
        },

        filterInstructors() {
          if (!this.instructors) return;
          if (!this.search) {
            this.filteredInstructors = this.instructors;
            return;
          }
          const q = this.search.toLowerCase();
          this.filteredInstructors = this.instructors.filter(i => 
            (i.users && i.users.name && i.users.name.toLowerCase().includes(q)) || 
            (i.users && i.users.email && i.users.email.toLowerCase().includes(q)) ||
            (i.divisions && i.divisions.name && i.divisions.name.toLowerCase().includes(q)) ||
            (i.divisions && i.divisions.code && i.divisions.code.toLowerCase().includes(q))
          );
        },

        filterDivisions() {
          if (!this.divisions) return;
          if (!this.search) {
            this.filteredDivisions = this.divisions;
            return;
          }
          const q = this.search.toLowerCase();
          this.filteredDivisions = this.divisions.filter(d => 
            (d.name && d.name.toLowerCase().includes(q)) || 
            (d.code && d.code.toLowerCase().includes(q))
          );
        },

        filterCatalog() {
          if (!this.catalog) return;
          if (!this.search) {
            this.filteredCatalog = this.catalog;
            return;
          }
          const q = this.search.toLowerCase();
          this.filteredCatalog = this.catalog.filter(c => 
            (c.treatment_name && c.treatment_name.toLowerCase().includes(q)) || 
            (c.divisions && c.divisions.name && c.divisions.name.toLowerCase().includes(q))
          );
        },

        filterTypeOfCases() {
          if (!this.caseTypes) return;
          if (!this.search) {
            this.filteredCaseTypes = this.caseTypes;
            return;
          }
          const q = this.search.toLowerCase();
          this.filteredCaseTypes = this.caseTypes.filter(c => 
            (c.type_of_case && c.type_of_case.toLowerCase().includes(q))
          );
        },

        filterSteps() {
          if (!this.steps) return;
          let result = this.steps;

          // Division filter
          if (this.stepsFilterDivision) {
            result = result.filter(s => s.treatment_catalog && s.treatment_catalog.division_id === this.stepsFilterDivision);
          }

          // Treatment filter
          if (this.stepsFilterTreatment) {
            result = result.filter(s => s.treatment_id === this.stepsFilterTreatment);
          }

          // Text search
          if (this.search) {
            const q = this.search.toLowerCase();
            result = result.filter(s => 
              (s.step_name && s.step_name.toLowerCase().includes(q)) || 
              (s.treatment_catalog && s.treatment_catalog.treatment_name && s.treatment_catalog.treatment_name.toLowerCase().includes(q)) ||
              String(s.step_order).includes(q)
            );
          }

          this.filteredSteps = result;
        },

        filterRequirements() {
          if (!this.requirements) return;
          let result = this.requirements;

          // Division filter
          if (this.requirementsFilterDivision) {
            result = result.filter(r => r.division_id === this.requirementsFilterDivision);
          }

          // Text search
          if (this.search) {
            const q = this.search.toLowerCase();
            result = result.filter(r => 
              (r.requirement_type && r.requirement_type.toLowerCase().includes(q)) || 
              (r.divisions && r.divisions.name && r.divisions.name.toLowerCase().includes(q))
            );
          }
          this.filteredRequirements = result;
        },

        filterPhases() {
          if (!this.phases) return;
          if (!this.search) {
            this.filteredPhases = this.phases;
            return;
          }
          const q = this.search.toLowerCase();
          this.filteredPhases = this.phases.filter(p => 
            (p.phase_name && p.phase_name.toLowerCase().includes(q)) || 
            String(p.phase_order).includes(q)
          );
        },

        // 
        //  Data Loading
        // 

        loadInitData() {
          this.loading = true;
          google.script.run
            .withSuccessHandler(data => {
              this.users = data.users || [];
              this.instructors = data.instructors || [];
              this.students = data.students || [];
              this.divisions = data.divisions || [];
              this.floors = data.floors || [];
              this.phases = data.phases || [];
              this.catalog = data.catalog || [];
              this.steps = data.steps || [];
              this.caseTypes = data.caseTypes || [];
              this.requirements = (data.requirements || []).sort((a, b) => {
                const divA = (a.divisions ? a.divisions.name : '').toLowerCase();
                const divB = (b.divisions ? b.divisions.name : '').toLowerCase();
                if (divA !== divB) return divA.localeCompare(divB);
                return (a.requirement_type || '').toLowerCase().localeCompare((b.requirement_type || '').toLowerCase());
              });
              
              // Initialize filtered lists
              this.filterUsers();
              this.filterStudents();
              this.filterInstructors();
              this.filterDivisions();
              this.filterPhases();
              this.filterCatalog();
              this.filterSteps();
              this.filterRequirements();
              this.filterTypeOfCases();
              
              this.loading = false;
            })
            .withFailureHandler(err => {
              console.error("Failed to load initial data", err);
              this.warningType = 'error';
              this.warningMessage = "Failed to load data from Supabase. Quota might be exceeded or connection is unstable.\n" + err.message;
              this.warningOpen = true;
              this.loading = false;
            })
            .adminGetInitData();
        },

        loadUsers() {
          this.loading = true;
          google.script.run
            .withSuccessHandler(data => {
              this.users = data;
              this.loading = false;
            })
            .withFailureHandler(err => {
              console.error(err); // Log silently, alert on specific action?
              this.loading = false;
            })
            .adminListUsers();
        },

        loadStudents() {
          this.loading = true;
          google.script.run
            .withSuccessHandler(data => {
              this.students = data;
              this.filteredStudents = data; // Init filtered
              this.loading = false;
            })
            .withFailureHandler(err => {
               console.error("Failed to load students", err);
               this.loading = false;
            })
            .adminListStudents();
        },

        loadDivisions() {
          // Don't set global loading true if users are already loaded, maybe separate loader?
          // For now, simplicity:
          google.script.run
            .withSuccessHandler(data => {
              this.divisions = data;
            })
            .withFailureHandler(err => {
              console.error("Failed to load divisions", err);
            })
            .adminListDivisions();
        },

        loadFloors() {
          google.script.run
            .withSuccessHandler(data => {
              this.floors = data;
            })
            .withFailureHandler(err => {
               console.error("Failed to load floors", err);
            })
            .adminListFloors();
        },

        loadTreatmentPhases() {
          google.script.run
            .withSuccessHandler(data => {
              this.phases = data;
            })
            .withFailureHandler(err => {
               console.error("Failed to load treatment phases", err);
            })
            .adminListTreatmentPhases();
        },

        loadTreatmentCatalog() {
          google.script.run
            .withSuccessHandler(data => {
              // Sort by Division Name, then Treatment Name
              this.catalog = data.sort((a, b) => {
                const divA = (a.divisions ? a.divisions.name : '').toLowerCase();
                const divB = (b.divisions ? b.divisions.name : '').toLowerCase();
                if (divA !== divB) return divA.localeCompare(divB);
                return (a.treatment_name || '').toLowerCase().localeCompare((b.treatment_name || '').toLowerCase());
              });
            })
            .withFailureHandler(err => {
               console.error("Failed to load treatment catalog", err);
            })
            .adminListTreatmentCatalog();
        },

        loadTreatmentSteps() {
          google.script.run
            .withSuccessHandler(data => {
              // Sort by Division, then Treatment, then Step Order
              this.steps = data.sort((a, b) => {
                const divA = (a.treatment_catalog && a.treatment_catalog.divisions ? a.treatment_catalog.divisions.name : '').toLowerCase();
                const divB = (b.treatment_catalog && b.treatment_catalog.divisions ? b.treatment_catalog.divisions.name : '').toLowerCase();
                if (divA !== divB) return divA.localeCompare(divB);

                const txA = (a.treatment_catalog ? a.treatment_catalog.treatment_name : '').toLowerCase();
                const txB = (b.treatment_catalog ? b.treatment_catalog.treatment_name : '').toLowerCase();
                if (txA !== txB) return txA.localeCompare(txB);

                return (a.step_order || 0) - (b.step_order || 0);
              });
            })
            .withFailureHandler(err => {
               console.error("Failed to load treatment steps", err);
            })
            .adminListTreatmentSteps();
        },

        loadRequirements() {
          google.script.run
            .withSuccessHandler(data => {
              // Sort by Division, then Requirement Type
              this.requirements = data.sort((a, b) => {
                const divA = (a.divisions ? a.divisions.name : '').toLowerCase();
                const divB = (b.divisions ? b.divisions.name : '').toLowerCase();
                if (divA !== divB) return divA.localeCompare(divB);
                return (a.requirement_type || '').toLowerCase().localeCompare((b.requirement_type || '').toLowerCase());
              });
            })
            .withFailureHandler(err => {
               console.error("Failed to load requirements", err);
            })
            .adminListRequirements();
        },

        loadTypeOfCases() {
          google.script.run
            .withSuccessHandler(data => {
              this.caseTypes = data || [];
              this.filterTypeOfCases();
            })
            .withFailureHandler(err => {
               console.error("Failed to load case types", err);
            })
            .adminListTypeOfCases();
        },

        loadInstructors() {
          google.script.run
            .withSuccessHandler(data => {
              this.instructors = data;
            })
            .withFailureHandler(err => {
               console.error("Failed to load instructors", err);
            })
            .adminListInstructors();
        },

        // 
        //  Modal / Form Handling
        // 

        openModal(mode, item = null) {
          this.mode = mode;
          this.errorMsg = '';
          this.modalOpen = true;

          if (this.activeTab === 'users' || this.activeTab === 'instructors' || this.activeTab === 'students') {
            if (mode === 'create') {
              this.userForm = {
                user_id: null,
                email: '',
                name: '',
                role: 'student', // Default
                status: 'active',
                first_clinic_year: new Date().getFullYear(),
                teamleader_role: false,
                division_id: '',
                floor_id: '',
                bay: '',
                team_leader_1_id: '',
                team_leader_2_id: ''
              };
            } else {
              // Edit User - Optimistic
               this.userForm = { 
                ...item,
                first_clinic_year: new Date().getFullYear(),
                teamleader_role: false,
                division_id: item.division_id || '',
                floor_id: item.floor_id || item.floor || '', // Support both for display
                bay: item.bay || '',
                oper_instructor_id: item.oper_instructor_id || '',
                endo_instructor_id: item.endo_instructor_id || '',
                perio_instructor_id: item.perio_instructor_id || '',
                prosth_instructor_id: item.prosth_instructor_id || '',
                diag_instructor_id: item.diag_instructor_id || '',
                radio_instructor_id: item.radio_instructor_id || '',
                sur_instructor_id: item.sur_instructor_id || '',
                ortho_instructor_id: item.ortho_instructor_id || '',
                pedo_instructor_id: item.pedo_instructor_id || ''
              };
              this.fetchUserDetail(item.email);
            }
          } else if (this.activeTab === 'divisions') {
            // Divisions
            if (mode === 'create') {
              this.divForm = { division_id: null, code: '', name: '', clinic: 'N/A', have_non_main_patient_requirements: true };
            } else {
              this.divForm = { ...item, clinic: item.clinic || 'N/A', have_non_main_patient_requirements: item.have_non_main_patient_requirements ?? true };
            }
          } else if (this.activeTab === 'phases') {
            // Treatment Phases
            if (mode === 'create') {
              this.phaseForm = { phase_id: null, phase_order: '', phase_name: '' };
            } else {
              this.phaseForm = { ...item };
            }
          } else if (this.activeTab === 'catalog') {
            // Treatment Catalog
            if (mode === 'create') {
              this.catalogForm = { treatment_id: null, division_id: '', treatment_name: '' };
            } else {
              this.catalogForm = { treatment_id: item.treatment_id, division_id: item.division_id || '', treatment_name: item.treatment_name || '' };
            }
          } else if (this.activeTab === 'caseTypes') {
            // Case Types
            if (mode === 'create') {
              this.caseTypeForm = { id: null, type_of_case: '' };
            } else {
              this.caseTypeForm = { ...item };
            }
          } else if (this.activeTab === 'steps') {
            // Treatment Steps
            if (mode === 'create') {
              this.stepForm = { step_id: null, treatment_id: '', step_order: '', step_name: '' };
              // Don't reset stepDivisionFilter, user might be adding multiple steps for same division
            } else {
              this.stepForm = { step_id: item.step_id, treatment_id: item.treatment_id || '', step_order: item.step_order || '', step_name: item.step_name || '' };
              // Set the division filter so the correct treatment catalog is shown
              if (item.treatment_catalog && item.treatment_catalog.division_id) {
                this.stepDivisionFilter = item.treatment_catalog.division_id;
              }
            }
          } else if (this.activeTab === 'requirements') {
            // Requirements
            if (mode === 'create') {
              this.reqForm = { requirement_id: null, division_id: '', requirement_type: '', cda_requirement_type: '', minimum_rsu: '', minimum_cda: '', rsu_unit: 'Case', cda_unit: 'Case', is_patient_treatment: true, non_mc_pateint_req: true, is_selectable: true, is_exam: false, aggregation_config: '' };
            } else {
              this.reqForm = { ...item, cda_requirement_type: item.cda_requirement_type || '', is_patient_treatment: item.is_patient_treatment !== false, non_mc_pateint_req: item.non_mc_pateint_req !== false, is_selectable: item.is_selectable !== false, is_exam: item.is_exam === true, aggregation_config: item.aggregation_config ? JSON.stringify(item.aggregation_config, null, 2) : '' };
            }
          } else {
            // Floors
             if (mode === 'create') {
              this.floorForm = { floor_id: null, label: '' };
            } else {
              this.floorForm = { ...item };
            }
          }
        },

        fetchUserDetail(email) {
           this.saving = true; 
           this.errorMsg = 'Loading details...';
           google.script.run
            .withSuccessHandler(fullUser => {
               this.userForm = { 
                 ...fullUser,
                 first_clinic_year: fullUser.first_clinic_year || new Date().getFullYear(),
                 teamleader_role: !!fullUser.teamleader_role,
                 division_id: fullUser.division_id || '',
                 floor_id: fullUser.floor_id || fullUser.floor || '',
                 bay: fullUser.bay || '',
                 team_leader_1_id: fullUser.team_leader_1_id || '',
                 team_leader_2_id: fullUser.team_leader_2_id || '',
                 oper_instructor_id: fullUser.oper_instructor_id || '',
                 endo_instructor_id: fullUser.endo_instructor_id || '',
                 perio_instructor_id: fullUser.perio_instructor_id || '',
                 prosth_instructor_id: fullUser.prosth_instructor_id || '',
                 diag_instructor_id: fullUser.diag_instructor_id || '',
                 radio_instructor_id: fullUser.radio_instructor_id || '',
                 sur_instructor_id: fullUser.sur_instructor_id || '',
                 ortho_instructor_id: fullUser.ortho_instructor_id || '',
                 pedo_instructor_id: fullUser.pedo_instructor_id || ''
               };
               this.saving = false;
               this.errorMsg = '';
            })
            .withFailureHandler(err => {
               this.errorMsg = 'Failed to load details: ' + err.message;
               this.saving = false;
            })
            .adminGetUserDetail(email);
        },

        closeModal() {
          this.modalOpen = false;
        },

        saveData() {
          if (this.activeTab === 'users' || this.activeTab === 'instructors' || this.activeTab === 'students') this.saveUser();
          else if (this.activeTab === 'divisions') this.saveDivision();
          else if (this.activeTab === 'phases') this.saveTreatmentPhase();
          else if (this.activeTab === 'catalog') this.saveTreatmentCatalog();
          else if (this.activeTab === 'steps') this.saveTreatmentStep();
          else if (this.activeTab === 'requirements') this.saveRequirement();
          else if (this.activeTab === 'caseTypes') this.saveTypeOfCase();
          else this.saveFloor();
        },

        saveUser() {
          this.saving = true;
          this.errorMsg = '';
          
          const handler = (res) => {
            this.saving = false;
            if (res.success) {
              if (res.warning) {
                this.warningMessage = res.warning;
                this.warningOpen = true;
              }
              this.closeModal();
              this.loadUsers(); 
              if(this.activeTab === 'instructors') this.loadInstructors();
              if(this.activeTab === 'students') this.loadStudents();            } else {
              this.errorMsg = res.error || 'Unknown error occurred.';
            }
          };

          if (this.mode === 'create') {
            google.script.run
              .withSuccessHandler(handler)
              .withFailureHandler(err => { this.saving = false; this.errorMsg = err.message; })
              .adminCreateUser(this.userForm);
          } else {
            google.script.run
              .withSuccessHandler(handler)
              .withFailureHandler(err => { this.saving = false; this.errorMsg = err.message; })
              .adminUpdateUser(this.userForm.user_id, this.userForm);
          }
        },

        saveDivision() {
          this.saving = true;
          this.errorMsg = '';
          
          const handler = (res) => {
            this.saving = false;
            if (res.success) {
              this.closeModal();
              this.loadDivisions(); 
            } else {
              this.errorMsg = res.error || 'Unknown error occurred.';
            }
          };

          if (this.mode === 'create') {
            google.script.run
              .withSuccessHandler(handler)
              .withFailureHandler(err => { this.saving = false; this.errorMsg = err.message; })
              .adminCreateDivision(this.divForm);
          } else {
            google.script.run
              .withSuccessHandler(handler)
              .withFailureHandler(err => { this.saving = false; this.errorMsg = err.message; })
              .adminUpdateDivision(this.divForm.division_id, this.divForm);
          }
        },

        saveFloor() {
          this.saving = true;
          this.errorMsg = '';
          
          const handler = (res) => {
            this.saving = false;
            if (res.success) {
              this.closeModal();
              this.loadFloors(); 
            } else {
              this.errorMsg = res.error || 'Unknown error occurred.';
            }
          };

          if (this.mode === 'create') {
            google.script.run
              .withSuccessHandler(handler)
              .withFailureHandler(err => { this.saving = false; this.errorMsg = err.message; })
              .adminCreateFloor(this.floorForm);
          } else {
             google.script.run
              .withSuccessHandler(handler)
              .withFailureHandler(err => { this.saving = false; this.errorMsg = err.message; })
              .adminUpdateFloor(this.floorForm.floor_id, this.floorForm);
          }
        },

        saveTreatmentPhase() {
          this.saving = true;
          this.errorMsg = '';
          
          const handler = (res) => {
            this.saving = false;
            if (res.success) {
              this.closeModal();
              this.loadTreatmentPhases(); 
            } else {
              this.errorMsg = res.error || 'Unknown error occurred.';
            }
          };

          if (this.mode === 'create') {
            google.script.run
              .withSuccessHandler(handler)
              .withFailureHandler(err => { this.saving = false; this.errorMsg = err.message; })
              .adminCreateTreatmentPhase(this.phaseForm);
          } else {
             google.script.run
              .withSuccessHandler(handler)
              .withFailureHandler(err => { this.saving = false; this.errorMsg = err.message; })
              .adminUpdateTreatmentPhase(this.phaseForm.phase_id, this.phaseForm);
          }
        },

        deleteTreatmentPhase(phase, event) {
          this.confirmMessage = 'Are you sure you want to delete phase "' + phase.phase_name + '"?\nThis action cannot be undone.';
          this.confirmOpen = true;
          
          const btn = event.currentTarget;
          
          this.confirmCallback = () => {
             this.performDeleteTreatmentPhase(phase, btn);
          };
        },

        performDeleteTreatmentPhase(phase, btn) {
          const originalText = btn.innerHTML;
          btn.innerHTML = '<span class="spinner w-3 h-3 border-2 border-red-500 border-t-transparent rounded-full animate-spin inline-block"></span>';
          btn.disabled = true;

          google.script.run
            .withSuccessHandler(res => {
               if (res.success) {
                 this.phases = this.phases.filter(p => p.phase_id !== phase.phase_id);
               } else {
                 this.warningMessage = 'Failed to delete: ' + res.error;
                 this.warningOpen = true;
                 btn.innerHTML = originalText;
                 btn.disabled = false;
               }
            })
            .withFailureHandler(err => {
               this.warningMessage = 'Error: ' + err.message;
               this.warningOpen = true;
               btn.innerHTML = originalText;
               btn.disabled = false;
            })
            .adminDeleteTreatmentPhase(phase.phase_id);
        },

        saveTreatmentCatalog() {
          this.saving = true;
          this.errorMsg = '';
          
          const handler = (res) => {
            this.saving = false;
            if (res.success) {
              this.closeModal();
              this.loadTreatmentCatalog(); 
            } else {
              this.errorMsg = res.error || 'Unknown error occurred.';
            }
          };

          if (this.mode === 'create') {
            google.script.run
              .withSuccessHandler(handler)
              .withFailureHandler(err => { this.saving = false; this.errorMsg = err.message; })
              .adminCreateTreatmentCatalog(this.catalogForm);
          } else {
             google.script.run
              .withSuccessHandler(handler)
              .withFailureHandler(err => { this.saving = false; this.errorMsg = err.message; })
              .adminUpdateTreatmentCatalog(this.catalogForm.treatment_id, this.catalogForm);
          }
        },

        deleteTreatmentCatalog(item, event) {
          this.confirmMessage = 'Are you sure you want to delete treatment "' + item.treatment_name + '"?\nThis action cannot be undone.';
          this.confirmOpen = true;
          
          const btn = event.currentTarget;
          
          this.confirmCallback = () => {
             this.performDeleteTreatmentCatalog(item, btn);
          };
        },

        performDeleteTreatmentCatalog(item, btn) {
          const originalText = btn.innerHTML;
          btn.innerHTML = '<span class="spinner w-3 h-3 border-2 border-red-500 border-t-transparent rounded-full animate-spin inline-block"></span>';
          btn.disabled = true;

          google.script.run
            .withSuccessHandler(res => {
               if (res.success) {
                 this.catalog = this.catalog.filter(c => c.treatment_id !== item.treatment_id);
               } else {
                 this.warningMessage = 'Failed to delete: ' + res.error;
                 this.warningOpen = true;
                 btn.innerHTML = originalText;
                 btn.disabled = false;
               }
            })
            .withFailureHandler(err => {
               this.warningMessage = 'Error: ' + err.message;
               this.warningOpen = true;
               btn.innerHTML = originalText;
               btn.disabled = false;
            })
            .adminDeleteTreatmentCatalog(item.treatment_id);
        },

        saveTreatmentStep() {
          this.saving = true;
          this.errorMsg = '';
          
          const handler = (res) => {
            this.saving = false;
            if (res.success) {
              this.closeModal();
              this.loadTreatmentSteps(); 
            } else {
              this.errorMsg = res.error || 'Unknown error occurred.';
            }
          };

          if (this.mode === 'create') {
            google.script.run
              .withSuccessHandler(handler)
              .withFailureHandler(err => { this.saving = false; this.errorMsg = err.message; })
              .adminCreateTreatmentStep(this.stepForm);
          } else {
             google.script.run
              .withSuccessHandler(handler)
              .withFailureHandler(err => { this.saving = false; this.errorMsg = err.message; })
              .adminUpdateTreatmentStep(this.stepForm.step_id, this.stepForm);
          }
        },

        deleteTreatmentStep(step, event) {
          this.confirmMessage = 'Are you sure you want to delete step "' + step.step_name + '"?\nThis action cannot be undone.';
          this.confirmOpen = true;
          
          const btn = event.currentTarget;
          
          this.confirmCallback = () => {
             this.performDeleteTreatmentStep(step, btn);
          };
        },

        performDeleteTreatmentStep(step, btn) {
          const originalText = btn.innerHTML;
          btn.innerHTML = '<span class="spinner w-3 h-3 border-2 border-red-500 border-t-transparent rounded-full animate-spin inline-block"></span>';
          btn.disabled = true;

          google.script.run
            .withSuccessHandler(res => {
               if (res.success) {
                 this.steps = this.steps.filter(s => s.step_id !== step.step_id);
               } else {
                 this.warningMessage = 'Failed to delete: ' + res.error;
                 this.warningOpen = true;
                 btn.innerHTML = originalText;
                 btn.disabled = false;
               }
            })
            .withFailureHandler(err => {
               this.warningMessage = 'Error: ' + err.message;
               this.warningOpen = true;
               btn.innerHTML = originalText;
               btn.disabled = false;
            })
            .adminDeleteTreatmentStep(step.step_id);
        },

        saveRequirement() {
          this.saving = true;
          this.errorMsg = '';
          
          const handler = (res) => {
            this.saving = false;
            if (res.success) {
              this.closeModal();
              this.loadRequirements(); 
            } else {
              this.errorMsg = res.error || 'Unknown error occurred.';
            }
          };

          if (this.mode === 'create') {
            google.script.run
              .withSuccessHandler(handler)
              .withFailureHandler(err => { this.saving = false; this.errorMsg = err.message; })
              .adminCreateRequirement(this.reqForm);
          } else {
             google.script.run
              .withSuccessHandler(handler)
              .withFailureHandler(err => { this.saving = false; this.errorMsg = err.message; })
              .adminUpdateRequirement(this.reqForm.requirement_id, this.reqForm);
          }
        },

        deleteRequirement(req, event) {
          this.confirmMessage = 'Are you sure you want to delete requirement "' + req.requirement_type + '"?\nThis action cannot be undone.';
          this.confirmOpen = true;
          
          const btn = event.currentTarget;
          
          this.confirmCallback = () => {
             this.performDeleteRequirement(req, btn);
          };
        },

        performDeleteRequirement(req, btn) {
          const originalText = btn.innerHTML;
          btn.innerHTML = '<span class="spinner w-3 h-3 border-2 border-red-500 border-t-transparent rounded-full animate-spin inline-block"></span>';
          btn.disabled = true;

          google.script.run
            .withSuccessHandler(res => {
               if (res.success) {
                 this.requirements = this.requirements.filter(r => r.requirement_id !== req.requirement_id);
               } else {
                 this.warningMessage = 'Failed to delete: ' + res.error;
                 this.warningOpen = true;
                 btn.innerHTML = originalText;
                 btn.disabled = false;
               }
            })
            .withFailureHandler(err => {
               this.warningMessage = 'Error: ' + err.message;
               this.warningOpen = true;
               btn.innerHTML = originalText;
               btn.disabled = false;
            })
            .adminDeleteRequirement(req.requirement_id);
        },

        saveTypeOfCase() {
          this.saving = true;
          this.errorMsg = '';
          
          const handler = (res) => {
            this.saving = false;
            if (res.success) {
              this.closeModal();
              this.loadTypeOfCases(); 
            } else {
              this.errorMsg = res.error || 'Unknown error occurred.';
            }
          };

          if (this.mode === 'create') {
            google.script.run
              .withSuccessHandler(handler)
              .withFailureHandler(err => { this.saving = false; this.errorMsg = err.message; })
              .adminCreateTypeOfCase(this.caseTypeForm);
          } else {
             google.script.run
              .withSuccessHandler(handler)
              .withFailureHandler(err => { this.saving = false; this.errorMsg = err.message; })
              .adminUpdateTypeOfCase(this.caseTypeForm.id, this.caseTypeForm);
          }
        },

        deleteTypeOfCase(item, event) {
          this.confirmMessage = 'Are you sure you want to delete case type "' + item.type_of_case + '"?\nThis action cannot be undone.';
          this.confirmOpen = true;
          
          const btn = event.currentTarget;
          
          this.confirmCallback = () => {
             this.performDeleteTypeOfCase(item, btn);
          };
        },

        performDeleteTypeOfCase(item, btn) {
          const originalText = btn.innerHTML;
          btn.innerHTML = '<span class="spinner w-3 h-3 border-2 border-red-500 border-t-transparent rounded-full animate-spin inline-block"></span>';
          btn.disabled = true;

          google.script.run
            .withSuccessHandler(res => {
               if (res.success) {
                 this.caseTypes = this.caseTypes.filter(c => c.id !== item.id);
               } else {
                 this.warningMessage = 'Failed to delete: ' + res.error;
                 this.warningOpen = true;
                 btn.innerHTML = originalText;
                 btn.disabled = false;
               }
            })
            .withFailureHandler(err => {
               this.warningMessage = 'Error: ' + err.message;
               this.warningOpen = true;
               btn.innerHTML = originalText;
               btn.disabled = false;
            })
            .adminDeleteTypeOfCase(item.id);
        },

        // Confirm Modal Action
        confirmAction() {
          if (this.confirmCallback) {
            this.confirmCallback();
            this.confirmCallback = null;
          }
          this.confirmOpen = false;
        },

        deleteUser(user, event) {
          this.confirmMessage = 'Are you sure you want to delete ' + (user.name || user.email) + '?\nThis action cannot be undone.';
          this.confirmOpen = true;
          
          // Capture button reference for spinner
          const btn = event.currentTarget;
          
          this.confirmCallback = () => {
             this.performDeleteUser(user, btn);
          };
        },

        performDeleteUser(user, btn) {
          const originalText = btn.innerHTML;
          btn.innerHTML = '<span class="spinner w-3 h-3 border-2 border-red-500 border-t-transparent rounded-full animate-spin inline-block"></span>';
          btn.disabled = true;

          google.script.run
            .withSuccessHandler(res => {
               if (res.success) {
                 this.users = this.users.filter(u => u.user_id !== user.user_id);
               } else {
                 this.warningMessage = 'Failed to delete: ' + res.error;
                 this.warningOpen = true;
                 btn.innerHTML = originalText;
                 btn.disabled = false;
               }
            })
            .withFailureHandler(err => {
               this.warningMessage = 'Error: ' + err.message;
               this.warningOpen = true;
               btn.innerHTML = originalText;
               btn.disabled = false;
            })
            .adminDeleteUser(user.user_id);
        }
      }
    }
  </script>
</body>
</html>
