<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            navy:      { DEFAULT: '#1B2A4A', light: '#2A3E66', dark: '#111D35' },
            gold:      { DEFAULT: '#C4972F', light: '#D4AD4E' },
            surface:   '#F8F7F4',
            cardwhite: '#FFFFFF',
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', '-apple-system', 'sans-serif'],
          },
        },
      },
    }
  </script>
  <!-- Inter font -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <!-- Alpine.js -->
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <!-- Shared styles -->
  <?!= include('styles') ?>
</head>

<body class="min-h-screen flex items-center justify-center p-4"
      x-data="landingApp()"
      x-init="init()">

  <!-- ─── Admin Floating Button ─── -->
  <div x-show="state === 'authenticated' && profile.role === 'admin'" 
       x-transition 
       class="fixed top-4 right-4 z-50">
    <a href="<?= appUrl ?>?page=admin" 
       class="bg-white text-navy px-4 py-2 rounded-lg shadow-md font-medium text-sm hover:bg-gray-50 hover:scale-105 transition-all border border-gray-200 flex items-center gap-2">
       <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
       Admin Console
    </a>
  </div>

  <!-- ─── Loading State ─── -->
  <div x-show="state === 'loading'" x-transition class="text-center animate-fade-in">
    <div class="flex flex-col items-center gap-5">
      <!-- University crest placeholder -->
      <div class="w-16 h-16 rounded-full bg-navy flex items-center justify-center shadow-lg">
        <svg class="w-8 h-8 text-gold" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                d="M12 14l9-5-9-5-9 5 9 5zm0 0l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14zm-4 6v-7.5l4-2.222" />
        </svg>
      </div>
      <div class="spinner mx-auto"></div>
      <p class="text-sm text-gray-500 font-medium tracking-wide">Verifying your account…</p>
    </div>
  </div>

  <!-- ─── Access Denied ─── -->
  <div x-show="state === 'denied'" x-transition class="card animate-fade-in">
    <div class="text-center">
      <div class="w-14 h-14 rounded-full bg-red-50 flex items-center justify-center mx-auto mb-4">
        <svg class="w-7 h-7 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
        </svg>
      </div>
      <h2 class="text-lg font-semibold text-gray-800 mb-2">Access Restricted</h2>
      <p class="text-sm text-gray-500 leading-relaxed mb-4">
        This application is available only to
        <span class="font-medium text-navy">@rsu.ac.th</span> accounts.
      </p>
      <div class="bg-gray-50 rounded-lg p-3 text-xs text-gray-400" x-show="userEmail">
        Signed in as <span class="font-medium text-gray-600" x-text="userEmail"></span>
      </div>
    </div>
  </div>

  <!-- ─── User Not Found ─── -->
  <div x-show="state === 'not_found'" x-transition class="card animate-fade-in">
    <div class="text-center">
      <div class="w-14 h-14 rounded-full bg-amber-50 flex items-center justify-center mx-auto mb-4">
        <svg class="w-7 h-7 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z" />
        </svg>
      </div>
      <h2 class="text-lg font-semibold text-gray-800 mb-2">Account Not Registered</h2>
      <p class="text-sm text-gray-500 leading-relaxed mb-4">
        Your account is not yet registered in the system.<br />
        Please contact your program administrator.
      </p>
      <div class="bg-gray-50 rounded-lg p-3 text-xs text-gray-400">
        <span class="font-medium text-gray-600" x-text="userEmail"></span>
      </div>
    </div>
  </div>

  <!-- ─── Inactive Account ─── -->
  <div x-show="state === 'inactive'" x-transition class="card animate-fade-in">
    <div class="text-center">
      <div class="w-14 h-14 rounded-full bg-gray-100 flex items-center justify-center mx-auto mb-4">
        <svg class="w-7 h-7 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
        </svg>
      </div>
      <h2 class="text-lg font-semibold text-gray-800 mb-2">Account Deactivated</h2>
      <p class="text-sm text-gray-500 leading-relaxed mb-4">
        Your account has been deactivated.<br />
        Please contact your administrator to restore access.
      </p>
      <div class="bg-gray-50 rounded-lg p-3 text-xs text-gray-400">
        <span class="font-medium text-gray-600" x-text="profile.email"></span>
      </div>
    </div>
  </div>

  <!-- ─── Error State ─── -->
  <div x-show="state === 'error'" x-transition class="card animate-fade-in">
    <div class="text-center">
      <div class="w-14 h-14 rounded-full bg-red-50 flex items-center justify-center mx-auto mb-4">
        <svg class="w-7 h-7 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
      </div>
      <h2 class="text-lg font-semibold text-gray-800 mb-2">Something Went Wrong</h2>
      <p class="text-sm text-gray-500 leading-relaxed mb-4" x-text="errorMessage"></p>
      <button @click="init()"
              class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-navy text-white text-sm font-medium hover:bg-navy-light transition-colors">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
        </svg>
        Retry
      </button>
    </div>
  </div>

  <!-- ─── Profile Card (Authenticated) ─── -->
  <div x-show="state === 'authenticated'" x-transition class="w-full max-w-md animate-fade-in">

    <!-- Header / Branding strip -->
    <div class="bg-navy rounded-t-2xl px-6 py-5 text-center">
      <div class="flex items-center justify-center gap-3 mb-2">
        <div class="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center">
          <svg class="w-5 h-5 text-gold" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                  d="M12 14l9-5-9-5-9 5 9 5zm0 0l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14zm-4 6v-7.5l4-2.222" />
          </svg>
        </div>
        <div>
          <h1 class="text-white text-base font-semibold tracking-tight">Student Portal</h1>
          <p class="text-white/50 text-xs">Clinic Progress Report</p>
        </div>
      </div>
    </div>

    <!-- Profile body -->
    <div class="bg-white rounded-b-2xl border border-t-0 border-gray-200 shadow-lg">

      <!-- Avatar + Name + Badge -->
      <div class="px-6 pt-6 pb-4 text-center border-b border-gray-100">
        <!-- Avatar circle with initials -->
        <div class="w-16 h-16 rounded-full mx-auto mb-3 flex items-center justify-center text-xl font-bold text-white"
             :class="{
               'bg-gradient-to-br from-gold to-yellow-600': profile.role === 'admin',
               'bg-gradient-to-br from-blue-500 to-blue-700': profile.role === 'instructor',
               'bg-gradient-to-br from-emerald-500 to-emerald-700': profile.role === 'student',
             }"
             x-text="initials">
        </div>
        <h2 class="text-lg font-semibold text-gray-800" x-text="profile.name || 'Unknown'"></h2>
        <p class="text-sm text-gray-400 mt-0.5" x-text="profile.email"></p>
        <div class="mt-3">
          <span class="badge"
                :class="{
                  'badge-admin':      profile.role === 'admin',
                  'badge-instructor': profile.role === 'instructor',
                  'badge-student':    profile.role === 'student',
                }">
            <template x-if="profile.role === 'admin'">
              <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
              </svg>
            </template>
            <template x-if="profile.role === 'instructor'">
              <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
              </svg>
            </template>
            <template x-if="profile.role === 'student'">
              <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M12 14l9-5-9-5-9 5 9 5zm0 0l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14zm-4 6v-7.5l4-2.222" />
              </svg>
            </template>
            <span x-text="profile.role"></span>
          </span>
          <template x-if="profile.role === 'student'">
            <div class="mt-2 flex justify-center">
              <a href="<?= appUrl ?>?page=vault" target="_blank"
                 class="text-xs font-bold text-gold hover:text-gold-light hover:underline flex items-center gap-1 transition">
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>
                Requirement Vault
              </a>
            </div>
          </template>
        </div>
      </div>

      <!-- Details section -->
      <div class="px-6 py-4 space-y-0">

        <!-- Status -->
        <div class="detail-row">
          <span class="detail-label">Status</span>
          <span class="detail-value flex items-center gap-1.5">
            <span class="w-2 h-2 rounded-full"
                  :class="profile.status === 'active' ? 'bg-emerald-500' : 'bg-gray-300'"></span>
            <span x-text="profile.status" class="capitalize"></span>
          </span>
        </div>

        <!-- Role-specific: Student -->
        <template x-if="profile.role === 'student'">
          <div>
            <div class="detail-row" x-show="profile.first_clinic_year">
              <span class="detail-label">Student Year</span>
              <span class="detail-value" x-text="getStudentYear()"></span>
            </div>
            <div class="detail-row" x-show="getTeamLeaderName() !== '-'">
              <span class="detail-label">Team Leader</span>
              <span class="detail-value" x-text="getTeamLeaderName()"></span>
            </div>
            
            <!-- Rotate Clinic Link -->
            <div class="mt-4 pt-3 border-t border-gray-100 text-center">
              <button @click="openRotateModal()" 
                      class="text-sm font-semibold text-navy hover:text-navy-light hover:underline flex items-center justify-center gap-1 transition">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                Add Requirement (rotate clinic and out of MC patients)
              </button>
            </div>
          </div>
        </template>

        <!-- Role-specific: Instructor / Admin -->
        <template x-if="profile.role === 'instructor' || profile.role === 'admin'">
          <div>
            <div class="detail-row" x-show="profile.division">
              <span class="detail-label">Division</span>
              <span class="detail-value" x-text="profile.division ? profile.division.name : '—'"></span>
            </div>
            <div class="detail-row" x-show="profile.teamleader_role">
              <span class="detail-label">Team Leader</span>
              <span class="detail-value">
                <span class="inline-flex items-center gap-1 text-gold text-xs font-semibold">
                  <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                  </svg>
                  Yes
                </span>
              </span>
            </div>
          </div>
        </template>
      </div>

      <!-- Footer: data source indicator -->
      <div class="px-6 py-3 bg-gray-50 rounded-b-2xl border-t border-gray-100 flex flex-col gap-3">
        
        <!-- Back to Lobby -->
        <div class="w-full">
           <a href="<?= appUrl ?>" 
              class="flex items-center justify-center gap-2 w-full py-2 bg-white border border-gray-200 text-gray-700 text-sm font-medium rounded-lg hover:bg-gray-50 transition shadow-sm">
             <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg>
             Back to Lobby
           </a>
        </div>
        
        <!-- Admin Link -->
        <div x-show="profile.role === 'admin'" class="w-full">
           <a href="<?= ScriptApp.getService().getUrl() ?>?page=admin" 
              class="flex items-center justify-center gap-2 w-full py-2 bg-white border border-gray-200 text-navy text-sm font-medium rounded-lg hover:bg-navy hover:text-white transition shadow-sm">
             <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
             Admin Console
           </a>
        </div>

        <div class="flex items-center justify-between">
          <span class="text-[0.65rem] text-gray-400 uppercase tracking-wider font-medium">Data Source</span>
          <span class="flex items-center gap-1.5 text-[0.65rem] font-medium"
                :class="profile.source === 'supabase' ? 'text-emerald-600' : 'text-amber-600'">
            <span class="source-dot" :class="profile.source"></span>
            <span x-text="profile.source === 'supabase' ? 'Supabase' : 'Google Sheets'"></span>
          </span>
        </div>
      </div>
    </div>

    <!-- ─── Patient Detail Modal ─── -->
    <div x-show="editModalOpen" style="display: none;" 
         class="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm"
         x-transition.opacity>
      
      <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden animate-scale-in"
           @click.outside="editModalOpen = false">
           
        <!-- Modal Header -->
        <div class="bg-navy px-6 py-4 flex justify-between items-center text-white">
           <div>
             <h3 class="text-lg font-bold" x-text="editingPatient.name"></h3>
             <p class="text-sm opacity-75 font-mono">HN: <span x-text="editingPatient.hn"></span></p>
           </div>
           <button @click="editModalOpen = false" class="text-white/70 hover:text-white">
             <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
           </button>
        </div>

        <!-- Modal Body -->
        <div class="p-6 space-y-4 max-h-[70vh] overflow-y-auto">
           
           <!-- Status (Dropdown) -->
           <div>
              <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1">Status</label>
              <select x-model="editingPatient.status" class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm focus:border-navy focus:ring-navy">
                 <option>Waiting to Be Assigned</option>
                 <option>Full Chart</option>
                 <option>Treatment Plan</option>
                 <option>First Treatment Plan</option>
                 <option>Treatment Plan Approved</option>
                 <option>Initial Treatment</option>
                 <option>Inactive</option>
                 <option>Discharged</option>
                 <option>Orthodontic Treatment</option>
                 <option>Waiting in Recall Lists</option>
              </select>
            </div>

            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-100"
                 x-show="editingPatient.student_id_1 === profile.student_id">
               <div>
                  <label class="block text-xs font-bold text-navy uppercase tracking-wider">Complete Case</label>
               </div>
                <label class="relative inline-flex items-center cursor-pointer">
                   <input type="checkbox" x-model="editingPatient.is_completed_case" 
                          @change="toggleCompleteCase(editingPatient, true)"
                          class="sr-only peer">
                   <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-emerald-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-emerald-600"></div>
                </label>
            </div>
           
           <!-- Complexity and Type of Case -->
           <div class="grid grid-cols-2 gap-4">
             <div>
                <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1">Complexity</label>
                <input type="text" x-model="editingPatient.complexity" placeholder="e.g. 1, 2, 3"
                       class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm focus:border-navy focus:ring-navy">
             </div>
             <div>
                <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1">Type of Case</label>
                <select x-model="editingPatient.type_of_case" 
                        class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm focus:border-navy focus:ring-navy">
                   <option value="">(Select Type)</option>
                   <template x-for="tc in typeOfCases" :key="tc.id">
                      <option :value="tc.type_of_case" x-text="tc.type_of_case"></option>
                   </template>
                </select>
             </div>
           </div>

           <div class="grid grid-cols-2 gap-4">
             <!-- Birthdate -->
             <div>
                <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1">Birthdate</label>
                <input type="date" x-model="editingPatient.birthdate" class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm">
             </div>
             <!-- Tel -->
             <div>
                <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1">Tel</label>
                <input type="text" x-model="editingPatient.tel" class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm">
             </div>
           </div>


           <!-- Note -->
           <div>
              <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1">Note</label>
              <textarea x-model="editingPatient.note" rows="2" class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm"></textarea>
           </div>

           <!-- Operators (Collapsible or just list) -->
           <div class="border-t border-gray-100 pt-4">
              <h4 class="text-sm font-semibold text-navy mb-3">Care Team</h4>
              
              <!-- Instructor -->
              <div class="mb-3 p-2 bg-blue-50/50 rounded border border-blue-50">
                 <label class="block text-xs font-semibold text-blue-800 mb-1">Instructor</label>
                 <div class="text-sm text-gray-700 font-medium" x-text="editingPatient.instructor_name || '-'"></div>
              </div>

              <div class="space-y-3">
                 <!-- Student 1 -->
                 <div>
                    <label class="block text-xs text-gray-400 mb-1">
                       Main Operator 

                    </label>
                    <div class="mb-1 text-sm font-mono text-gray-500" x-text="editingPatient.student_1_acad"></div>
                    <div class="text-sm font-medium text-navy min-h-[1.25rem]" x-text="editingPatient.student_1_name"></div>
                 </div>
                 
                 <!-- Referrals -->
                 <div class="grid grid-cols-2 gap-3" x-show="editingPatient.student_1_acad">
                    <div>
                       <label class="block text-xs text-gray-400 mb-1">
                          Ref 1

                       </label>
                       <div class="mb-1 text-xs font-mono text-gray-500" x-text="editingPatient.student_2_acad || '-'"></div>
                       <div class="text-xs font-medium text-gray-700 min-h-[1rem]" x-text="editingPatient.student_2_name !== '-' ? editingPatient.student_2_name : ''"></div>
                    </div>
                    <div>
                       <label class="block text-xs text-gray-400 mb-1">
                          Ref 2

                       </label>
                       <div class="mb-1 text-xs font-mono text-gray-500" x-text="editingPatient.student_3_acad || '-'"></div>
                       <div class="text-xs font-medium text-gray-700 min-h-[1rem]" x-text="editingPatient.student_3_name !== '-' ? editingPatient.student_3_name : ''"></div>
                    </div>
                    <div>
                       <label class="block text-xs text-gray-400 mb-1">
                          Ref 3

                       </label>
                       <div class="mb-1 text-xs font-mono text-gray-500" x-text="editingPatient.student_4_acad || '-'"></div>
                       <div class="text-xs font-medium text-gray-700 min-h-[1rem]" x-text="editingPatient.student_4_name !== '-' ? editingPatient.student_4_name : ''"></div>
                    </div>
                    <div>
                       <label class="block text-xs text-gray-400 mb-1">
                          Ref 4

                       </label>
                       <div class="mb-1 text-xs font-mono text-gray-500" x-text="editingPatient.student_5_acad || '-'"></div>
                       <div class="text-xs font-medium text-gray-700 min-h-[1rem]" x-text="editingPatient.student_5_name !== '-' ? editingPatient.student_5_name : ''"></div>
                    </div>
                 </div>
              </div>
           </div>
        </div>

        <!-- Modal Footer -->
        <div class="px-6 py-4 bg-gray-50 border-t border-gray-100 flex flex-col gap-3">
           <a :href="'<?= appUrl ?>?page=treatment_plan&hn=' + encodeURIComponent(editingPatient.hn)" 
              target="_blank"
              class="w-full py-2 bg-white border border-navy text-navy font-semibold rounded-lg shadow-sm hover:bg-navy hover:text-white transition flex justify-center items-center">
              View Treatment Plan
           </a>
           <button @click="savePatient()" 
                   x-show="editingPatient.student_id_1 === profile.student_id"
                   class="w-full py-2 bg-emerald-600 text-white font-semibold rounded-lg shadow-md hover:bg-emerald-700 transition flex justify-center items-center gap-2" :disabled="saving">
              <span x-show="saving" class="spinner w-4 h-4 border-white/30 border-t-white"></span>
              <span x-text="saving ? 'Saving...' : 'Save Changes'"></span>
           </button>
        </div>

      </div>
    </div>

    <!-- ─── Patient List (Student Only) ─── -->
    <template x-if="profile.role === 'student' && state === 'authenticated'">
      <div class="mt-6 w-full space-y-8 animate-fade-in" style="animation-delay: 100ms">
        
        <div x-show="loadingPatients" class="text-center py-4">
           <div class="spinner w-5 h-5 border-2 border-navy/20 border-t-navy mx-auto"></div>
        </div>

        <div x-show="!loadingPatients && myPatients.length === 0 && referredPatients.length === 0" class="text-center py-6 bg-white rounded-xl border border-gray-100 shadow-sm">
           <p class="text-sm text-gray-400">No patients assigned yet.</p>
        </div>

        <!-- My Patients Group -->
        <div x-show="myPatients.length > 0">
           <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-3 px-1">My Patients</h3>
           <div class="space-y-3">
             <template x-for="p in myPatients" :key="p.hn">
               <div @click="openPatientModal(p)" class="cursor-pointer bg-white rounded-xl border border-gray-200 shadow-sm p-4 hover:shadow-md transition-shadow relative overflow-hidden">
                 <div class="absolute top-0 left-0 w-1 h-full bg-navy"></div>
                 <div class="pl-2 flex justify-between items-start mb-2">
                   <div>
                     <h4 class="font-semibold text-navy text-base" x-text="p.name"></h4>
                     <p class="text-xs text-gray-400 font-mono mt-0.5">HN: <span x-text="p.hn"></span></p>
                   </div>
                   <span class="px-2 py-1 rounded text-[0.65rem] font-bold uppercase tracking-wide border"
                         :class="{
                           'bg-emerald-50 text-emerald-600 border-emerald-100': ['Full Chart','Treatment Plan Approved'].includes(p.status),
                           'bg-blue-50 text-blue-600 border-blue-100': ['Treatment Plan','First Treatment Plan'].includes(p.status),
                           'bg-gray-50 text-gray-500 border-gray-100': ['Waiting to Be Assigned','Inactive','Discharged'].includes(p.status),
                           'bg-amber-50 text-amber-600 border-amber-100': !['Full Chart','Treatment Plan Approved','Treatment Plan','First Treatment Plan','Waiting to Be Assigned','Inactive','Discharged'].includes(p.status)
                         }"
                         x-text="p.status">
                   </span>
                  </div>
                  <div class="pl-2 flex justify-between items-center mb-2">
                    <div class="text-xs text-gray-500 space-y-1">
                       <p x-show="p.tel"><span class="font-medium text-gray-400">Tel:</span> <span x-text="p.tel"></span></p>
                    </div>
                    <!-- Toggle Switch -->
                    <div class="flex items-center gap-2" @click.stop>
                       <span class="text-[0.65rem] font-bold uppercase tracking-wide transition-colors" :class="p.is_completed_case ? 'text-emerald-600' : 'text-gray-400'">Complete Case</span>
                       <label class="relative inline-flex items-center cursor-pointer scale-90">
                          <input type="checkbox" x-model="p.is_completed_case" @change="toggleCompleteCase(p, false)" class="sr-only peer">
                          <div class="w-9 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-emerald-600"></div>
                       </label>
                    </div>
                  </div>
                  <div class="pl-2 text-xs text-gray-500">
                     <p x-show="p.note" class="italic text-gray-400 mt-2 border-t border-gray-50 pt-2" x-text="p.note"></p>
                  </div>
               </div>
             </template>
           </div>
        </div>

        <!-- Referred Patients Group -->
        <div x-show="referredPatients.length > 0">
           <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-3 px-1">Referred / Co-Treat</h3>
           <div class="space-y-3">
             <template x-for="p in referredPatients" :key="p.hn">
               <div @click="openPatientModal(p)" class="cursor-pointer bg-gray-50 rounded-xl border border-gray-200 shadow-sm p-4 hover:shadow-md transition-shadow relative overflow-hidden">
                 <div class="absolute top-0 left-0 w-1 h-full bg-gold"></div>
                 <div class="pl-2 flex justify-between items-start mb-2">
                   <div>
                     <h4 class="font-semibold text-gray-700 text-base" x-text="p.name"></h4>
                     <p class="text-xs text-gray-400 font-mono mt-0.5">HN: <span x-text="p.hn"></span></p>
                   </div>
                   <span class="px-2 py-1 rounded text-[0.65rem] font-bold uppercase tracking-wide border border-gray-200 bg-white text-gray-500"
                         x-text="p.status">
                   </span>
                 </div>
                  <div class="pl-2 flex justify-between items-center mb-2">
                    <div class="text-xs text-gray-500 space-y-1">
                       <p x-show="p.tel"><span class="font-medium text-gray-400">Tel:</span> <span x-text="p.tel"></span></p>
                    </div>
                  </div>
                  <div class="pl-2 text-xs text-gray-500">
                    <div class="mt-2 text-[0.65rem] text-gold font-medium uppercase tracking-wide">
                       Referred Case
                    </div>
                  </div>
               </div>
             </template>
           </div>
        </div>

      </div>
    </template>

  </div>

   <!-- ─── Treatment Plan Modal (Full-Screen Overlay) ─── -->
   <div x-show="tpModalOpen" style="display: none;"
        class="fixed inset-0 z-[80] bg-surface overflow-y-auto"
        x-transition:enter="transition ease-out duration-200"
        x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
        x-transition:leave="transition ease-in duration-150"
        x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0">
     <div class="min-h-screen p-6">
       <div class="max-w-6xl mx-auto mb-8 flex justify-between items-center">
         <div class="flex items-center gap-4">
           <button @click="tpModalOpen = false" class="p-2 rounded-full bg-white shadow-sm text-gray-400 hover:text-navy hover:bg-gray-50 transition">
             <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg>
           </button>
           <div>
             <h1 class="text-2xl font-bold text-navy">Treatment Plan</h1>
             <template x-if="tpPatient">
               <div class="flex items-center gap-3 text-sm text-gray-500 mt-1">
                  <span class="font-medium text-gray-800" x-text="tpPatient.name"></span>
                  <span class="w-1 h-1 rounded-full bg-gray-300"></span>
                  <span class="font-mono">HN: <span x-text="tpPatient.hn"></span></span>
               </div>
             </template>
           </div>
         </div>
       </div>
       <div class="max-w-6xl mx-auto">
         <div x-show="tpLoading" class="py-12 text-center">
           <div class="spinner mx-auto mb-3"></div>
           <p class="text-sm text-gray-400">Loading records...</p>
         </div>
         <template x-if="tpError">
           <div class="bg-red-50 border border-red-200 rounded-lg p-4 text-red-700 text-sm mb-4" x-text="tpError"></div>
         </template>
         <div x-show="!tpLoading && !tpError" class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
           <table class="w-full text-sm text-left">
             <thead class="bg-gray-50 text-gray-500 font-medium border-b border-gray-200">
               <tr>
                 <th class="px-4 py-3 w-16 text-center">#</th>
                 <th class="px-4 py-3 w-20">Area</th>
                 <th class="px-4 py-3">Treatment / Step</th>
                 <th class="px-4 py-3">Division</th>
                 <th class="px-4 py-3">Type</th>
                 <th class="px-4 py-3 w-32">Start</th>
                 <th class="px-4 py-3 w-32">Complete</th>
                 <th class="px-4 py-3 w-24 text-center">Status</th>
               </tr>
             </thead>
             <tbody class="divide-y divide-gray-100">
               <template x-for="r in tpRecords" :key="r.record_id">
                 <tr class="hover:bg-gray-50/50 transition-colors">
                   <td class="px-4 py-3 text-center text-gray-400 font-mono" x-text="r.treatment_order || '-'"></td>
                   <td class="px-4 py-3 font-semibold text-navy" x-text="r.area || '-'"></td>
                   <td class="px-4 py-3">
                     <div class="font-medium text-gray-800" x-text="r.treatment_catalog ? r.treatment_catalog.treatment_name : 'Unknown'"></div>
                     <div class="text-xs text-gray-400 mt-0.5" x-text="r.treatment_steps ? r.treatment_steps.step_name : (r.step_id ? 'Step ID: ' + r.step_id : 'No Step')"></div>
                   </td>
                   <td class="px-4 py-3 text-gray-500" x-text="r.treatment_catalog && r.treatment_catalog.divisions ? r.treatment_catalog.divisions.name : '-'"></td>
                   <td class="px-4 py-3 text-gray-500" x-text="r.treatment_catalog && r.treatment_catalog.requirement_list ? r.treatment_catalog.requirement_list.requirement_type : '-'"></td>
                   <td class="px-4 py-3 text-gray-500 font-mono text-xs" x-text="formatDate(r.start_date)"></td>
                   <td class="px-4 py-3 text-gray-500 font-mono text-xs" x-text="formatDate(r.complete_date)"></td>
                   <td class="px-4 py-3 text-center">
                      <span class="px-2 py-1 rounded-full text-[0.65rem] font-bold uppercase tracking-wide"
                            :class="{
                              'bg-gray-100 text-gray-500': r.status === 'planned',
                              'bg-blue-50 text-blue-600': r.status === 'in_progress',
                              'bg-emerald-50 text-emerald-600': r.status === 'completed' || r.status === 'verified'
                            }"
                            x-text="r.status"></span>
                   </td>
                 </tr>
               </template>
               <tr x-show="tpRecords.length === 0 && !tpLoading">
                 <td colspan="8" class="py-12 text-center text-gray-400 italic">No treatment records found.</td>
               </tr>
             </tbody>
           </table>
         </div>
       </div>
     </div>
   </div>

  <!-- ─── Error Popup Modal ─── -->
  <div x-show="errorModalOpen" style="display: none;"
       class="fixed inset-0 z-[70] flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm"
       x-transition.opacity>
    
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden animate-scale-in"
         @click.outside="errorModalOpen = false">
      <div class="p-6 text-center">
        <div class="w-16 h-16 rounded-full bg-red-50 flex items-center justify-center mx-auto mb-4">
          <svg class="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
          </svg>
        </div>
        <h3 class="text-lg font-bold text-gray-800 mb-2">Error</h3>
        <p class="text-sm text-gray-500 mb-6" x-text="errorModalMessage"></p>
        <button @click="errorModalOpen = false" 
                class="w-full py-2.5 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition">
          Close
        </button>
      </div>
    </div>
  </div>

  <!-- ─── Rotate Clinic Modal ─── -->
  <div x-show="rotateModalOpen" style="display: none;"
       class="fixed inset-0 z-[75] flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm"
       x-transition.opacity>
    
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden animate-scale-in flex flex-col max-h-[90vh]"
         @click.outside="rotateModalOpen = false">
      
      <!-- Header -->
      <div class="bg-navy px-6 py-4 flex justify-between items-center text-white shrink-0">
        <h3 class="text-lg font-bold">Add Non-Main-Clinic-Patient Requirement</h3>
        <button @click="rotateModalOpen = false" class="text-white/70 hover:text-white">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>

      <!-- Body -->
      <div class="p-6 space-y-4 overflow-y-auto">
        <div x-show="rotateLoading" class="text-center py-4">
           <div class="spinner w-6 h-6 border-navy/20 border-t-navy mx-auto"></div>
           <p class="text-xs text-gray-400 mt-2">Loading data...</p>
        </div>

        <div x-show="!rotateLoading" class="space-y-4">
          
          <!-- 1. Division -->
          <div>
            <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1">Select Division</label>
            <select x-model="rotateForm.division_id" @change="onRotateDivisionChange()"
                    class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:border-navy focus:ring-navy">
              <option value="">-- Select Clinic --</option>
              <template x-for="d in rotateDivisions" :key="d.division_id">
                <option :value="d.division_id" x-text="d.name"></option>
              </template>
            </select>
          </div>

          <!-- 2. Requirement -->
          <div x-show="rotateForm.division_id">
            <div class="flex items-center justify-between mb-1">
              <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider">Requirement</label>
              <div x-show="rotateOptionsLoading" class="spinner w-3 h-3 border-navy/20 border-t-navy"></div>
            </div>
            <select x-model="rotateForm.requirement_id" @change="onRotateRequirementChange()"
                    :disabled="rotateOptionsLoading"
                    class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:border-navy focus:ring-navy disabled:bg-gray-50">
              <option value="">-- Select Requirement --</option>
              <template x-for="r in rotateRequirements" :key="r.requirement_id">
                <option :value="r.requirement_id" x-text="r.requirement_type"></option>
              </template>
            </select>
          </div>

          <!-- 3. RSU / CDA Units -->
          <div x-show="rotateForm.requirement_id" class="grid grid-cols-2 gap-4">
             <div>
                <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1">RSU Requirement</label>
                <div class="flex items-center gap-2">
                   <input type="number" step="0.1" x-model="rotateForm.rsu_units" 
                          class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:border-navy focus:ring-navy bg-gray-50"
                          disabled>
                   <span class="text-xs text-gray-500 font-medium" x-show="rotateForm.rsu_unit" x-text="rotateForm.rsu_unit"></span>
                </div>
             </div>
             <div>
                <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1">CDA Requirement</label>
                <div class="flex items-center gap-2">
                   <input type="number" step="0.1" x-model="rotateForm.cda_units" 
                          class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:border-navy focus:ring-navy bg-gray-50"
                          disabled>
                   <span class="text-xs text-gray-500 font-medium" x-show="rotateForm.cda_unit" x-text="rotateForm.cda_unit"></span>
                </div>
             </div>
          </div>

          <!-- 4. Patient Info (Conditional) -->
          <div x-show="rotateForm.requirement_id && rotateForm.is_patient_treatment" class="p-3 bg-gray-50 rounded-lg border border-gray-200">
             <h4 class="text-xs font-bold text-navy uppercase mb-3 border-b border-gray-200 pb-1">Patient Information</h4>
             <div class="space-y-3">
                <div class="grid grid-cols-3 gap-3">
                   <div class="col-span-1">
                      <label class="block text-xs text-gray-500 mb-1">HN</label>
                      <input type="text" x-model="rotateForm.hn" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm">
                   </div>
                   <div class="col-span-2">
                      <label class="block text-xs text-gray-500 mb-1">Patient Name</label>
                      <input type="text" x-model="rotateForm.patient_name" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm">
                   </div>
                </div>
                <div>
                   <label class="block text-xs text-gray-500 mb-1">Area / Teeth / Description</label>
                   <input type="text" x-model="rotateForm.area" placeholder="e.g. Tooth 16, Full Mouth..." class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm">
                </div>
                <p class="text-[0.65rem] text-amber-600 mt-1">
                   * Note: If this patient is assigned to you in the main clinic, please submit via your Patient List instead.
                </p>
             </div>
          </div>

          <!-- 5. Advisor -->
          <div x-show="rotateForm.requirement_id">
            <div class="flex items-center justify-between mb-1">
              <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider">Advisor (Instructor)</label>
              <div x-show="rotateOptionsLoading" class="spinner w-3 h-3 border-navy/20 border-t-navy"></div>
            </div>
            <select x-model="rotateForm.instructor_id"
                    :disabled="rotateOptionsLoading"
                    class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:border-navy focus:ring-navy disabled:bg-gray-50">
              <option value="">-- Select Advisor --</option>
              <template x-for="i in rotateInstructors" :key="i.instructor_id">
                <option :value="i.instructor_id" x-text="i.user ? i.user.name : 'Unknown'"></option>
              </template>
            </select>
          </div>

        </div>
      </div>

      <!-- Footer -->
      <div class="px-6 py-4 bg-gray-50 border-t border-gray-100 flex justify-end gap-3 shrink-0">
         <button @click="rotateModalOpen = false" class="px-4 py-2 text-gray-500 hover:text-gray-700 font-medium text-sm">Cancel</button>
         <button @click="submitRotateRequirement()" 
                 :disabled="rotateSubmitting || !rotateForm.division_id || !rotateForm.requirement_id || !rotateForm.instructor_id"
                 class="px-4 py-2 bg-navy text-white font-medium rounded-lg shadow hover:bg-navy-light disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
            <span x-show="rotateSubmitting" class="spinner w-4 h-4 border-white/30 border-t-white"></span>
            <span x-text="rotateSubmitting ? 'Submitting...' : 'Submit'"></span>
         </button>
      </div>

    </div>
  </div>

  <!-- ─── Alpine.js App Logic ─── -->
  <script>
    function landingApp() {
      return {
        state: 'loading',     // loading | denied | not_found | inactive | authenticated | error
        userEmail: '',
        profile: {},
        initials: '',
        errorMessage: '',

        init() {
          this.state = 'loading';

          // Step 1: Get current user's email
          google.script.run
            .withSuccessHandler((result) => {
              this.userEmail = result.email;

              if (!result.allowed) {
                this.state = 'denied';
                return;
              }

              // Step 2: Fetch full profile
              google.script.run
                .withSuccessHandler((profile) => {
                  if (!profile.found) {
                    if (profile.reason === 'user_not_found') {
                      this.state = 'not_found';
                    } else if (profile.reason === 'access_denied') {
                      this.state = 'denied';
                    } else {
                      this.errorMessage = profile.message || 'An unexpected error occurred.';
                      this.state = 'error';
                    }
                    return;
                  }

                  if (!profile.active) {
                    this.profile = profile;
                    this.state = 'inactive';
                    return;
                  }

                  // Success
                  this.profile = profile;
                  this.initials = this._getInitials(profile.name);
                  this.state = 'authenticated';

                  if (profile.role === 'student') {
                     this.loadPatients();
                     this.loadTypeOfCases();
                  }
                })
                .withFailureHandler((err) => {
                  this.errorMessage = err.message || 'Failed to load profile.';
                  this.state = 'error';
                })
                .getUserProfile(result.email);
            })
            .withFailureHandler((err) => {
              this.errorMessage = err.message || 'Failed to verify account.';
              this.state = 'error';
            })
            .getCurrentUser();
        },

        _getInitials(name) {
          if (!name) return '?';
          var parts = name.trim().split(/\s+/);
          if (parts.length >= 2) {
            return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
          }
          return parts[0][0].toUpperCase();
        },

        getStudentYear() {
           if (!this.profile.first_clinic_year) return '-';
           const now = new Date();
           const currentYear = now.getFullYear();
           const month = now.getMonth(); // 0-based
           const date = now.getDate();
           
           // If current month is between mid Aug (15th) to Dec
           const isSecondHalf = (month > 7) || (month === 7 && date >= 15);
           const offset = isSecondHalf ? 5 : 4;
           
           return currentYear - parseInt(this.profile.first_clinic_year) + offset;
        },

        getTeamLeaderName() {
           const year = this.getStudentYear();
           if (year === '-') return '-';
           
           if (year == 5) return this.profile.team_leader_1_name || '-';
           if (year >= 6) return this.profile.team_leader_2_name || '-';
           return '-';
        },

        // --- Patient Logic ---
        loadingPatients: false,
        myPatients: [],
        referredPatients: [],
        typeOfCases: [],
        
        // Modal State
        editModalOpen: false,
        editingPatient: {},
        saving: false,

        // Treatment Plan Modal State
        tpModalOpen: false,
        tpLoading: false,
        tpPatient: null,
        tpRecords: [],
        tpError: '',

        loadPatients() {
           this.loadingPatients = true;
           google.script.run
             .withSuccessHandler((data) => {
                var myId = this.profile.student_id;
                this.myPatients = [];
                this.referredPatients = [];
                
                data.forEach(p => {
                  if (p.student_id_1 === myId) {
                    this.myPatients.push(p);
                  } else {
                    this.referredPatients.push(p);
                  }
                });
                
                this.loadingPatients = false;
             })
             .withFailureHandler((err) => {
                console.error("Failed to load patients", err);
                this.loadingPatients = false;
             })
              .getStudentPatients();
        },

        loadTypeOfCases() {
          google.script.run
            .withSuccessHandler((data) => {
               this.typeOfCases = data || [];
            })
            .withFailureHandler((err) => {
               console.error("Failed to load case types", err);
            })
            .studentListTypeOfCases();
        },

        toggleCompleteCase(p, fromModal = false) {
           // If called from modal, p is a copy (this.editingPatient)
           // If called from card, p is the original in the list
           
           // If p is from modal, we don't need to manually toggle newValue 
           // because x-model already updated it.
           // If from card, we use the passed value (which is currently @change triggered)
           
           const newValue = p.is_completed_case; 
           const hn = p.hn;
           
           // If from modal, sync to the list immediately
           if (fromModal) {
              const findInList = (list) => {
                 const match = list.find(item => item.hn === hn);
                 if (match) match.is_completed_case = newValue;
              };
              findInList(this.myPatients);
              findInList(this.referredPatients);
           }
           
           google.script.run
             .withSuccessHandler((res) => {
                if (!res.success) {
                  // Revert if failed
                  p.is_completed_case = !newValue;
                  if (fromModal) {
                     const findInList = (list) => {
                        const match = list.find(item => item.hn === hn);
                        if (match) match.is_completed_case = !newValue;
                     };
                     findInList(this.myPatients);
                     findInList(this.referredPatients);
                  }
                  this.showErrorModal("Failed to toggle completion status.");
                }
             })
             .withFailureHandler((err) => {
                // Revert
                p.is_completed_case = !newValue;
                if (fromModal) {
                   const findInList = (list) => {
                      const match = list.find(item => item.hn === hn);
                      if (match) match.is_completed_case = !newValue;
                   };
                   findInList(this.myPatients);
                   findInList(this.referredPatients);
                }
                this.showErrorModal("Error: " + err.message);
             })
             .studentToggleCompleteCase(hn, newValue);
        },

        openPatientModal(p) {
           // Deep copy to avoid mutating list directly
           this.editingPatient = p ? JSON.parse(JSON.stringify(p)) : {};
           // Format Date for input[type=date] (YYYY-MM-DD)
           if(this.editingPatient.birthdate) {
              this.editingPatient.birthdate = new Date(this.editingPatient.birthdate).toISOString().split('T')[0];
           }
           this.editModalOpen = true;
        },

        savePatient() {
           this.saving = true;
           google.script.run
              .withSuccessHandler(() => {
                 this.saving = false;
                 this.editModalOpen = false;
                 this.loadPatients(); // Refresh
              })
              .withFailureHandler((err) => {
                 this.saving = false;
                 this.showErrorModal(err.message || 'Update failed');
              })
              .studentUpdatePatient(this.editingPatient.hn, JSON.parse(JSON.stringify(this.editingPatient)));
        },


         formatDate(d) {
            if (!d) return '-';
            return new Date(d).toLocaleDateString('th-TH');
         },

        // --- Error Modal Logic ---
        errorModalOpen: false,
        errorModalMessage: '',
         
        showErrorModal(msg) {
           this.errorModalMessage = msg;
           this.errorModalOpen = true;
        },

        // --- Rotate Clinic Logic ---
        rotateModalOpen: false,
        rotateLoading: false,
        rotateOptionsLoading: false,
        rotateSubmitting: false,
        rotateDivisions: [],
        rotateRequirements: [],
        rotateInstructors: [],
        rotateForm: {
           division_id: '',
           requirement_id: '',
           rsu_units: 0,
           cda_units: 0,
           instructor_id: '',
           area: '',
           hn: '',
           patient_name: '',
           // Helpers (not sent)
           min_rsu: 0,
           min_cda: 0,
           rsu_unit: '',
           cda_unit: '',
           is_patient_treatment: false
        },

        openRotateModal() {
           this.rotateForm = { division_id: '', requirement_id: '', rsu_units: 0, cda_units: 0, instructor_id: '', area: '', hn: '', patient_name: '', min_rsu: 0, min_cda: 0, rsu_unit: '', cda_unit: '', is_patient_treatment: false };
           this.rotateModalOpen = true;
           this.rotateLoading = true;
           this.rotateOptionsLoading = false;
           
           google.script.run
             .withSuccessHandler((divs) => {
                this.rotateDivisions = divs;
                this.rotateLoading = false;
             })
             .withFailureHandler((err) => {
                this.showErrorModal("Failed to load divisions: " + err.message);
                this.rotateModalOpen = false;
             })
             .studentListRotateDivisions();
        },

        onRotateDivisionChange() {
           const divId = this.rotateForm.division_id;
           this.rotateRequirements = [];
           this.rotateInstructors = [];
           this.rotateForm.requirement_id = '';
           this.rotateForm.instructor_id = '';
           
           if (!divId) return;
           
           this.rotateOptionsLoading = true;
           let reqsDone = false;
           let instsDone = false;

           const checkAllDone = () => {
             if (reqsDone && instsDone) {
               this.rotateOptionsLoading = false;
             }
           };
           
           // Fetch Requirements
           google.script.run
             .withSuccessHandler((reqs) => {
                this.rotateRequirements = reqs;
                reqsDone = true;
                checkAllDone();
             })
             .withFailureHandler((err) => {
                console.error("Failed to load requirements", err);
                reqsDone = true;
                checkAllDone();
             })
             .studentListNonMCRequirementsByDivision(divId);
             
           // Fetch Instructors
           google.script.run
             .withSuccessHandler((insts) => {
                this.rotateInstructors = insts;
                instsDone = true;
                checkAllDone();
             })
             .withFailureHandler((err) => {
                console.error("Failed to load instructors", err);
                instsDone = true;
                checkAllDone();
             })
             .studentListInstructorsByDivision(divId);
        },

        onRotateRequirementChange() {
           const reqId = this.rotateForm.requirement_id;
           
           if (!reqId) {
             // Reset if no requirement selected
             this.rotateForm.min_rsu = 0;
             this.rotateForm.min_cda = 0;
             this.rotateForm.is_patient_treatment = false;
             this.rotateForm.rsu_units = 0;
             this.rotateForm.cda_units = 0;
             this.rotateForm.rsu_unit = '';
             this.rotateForm.cda_unit = '';
             return;
           }
           
           const req = this.rotateRequirements.find(r => r.requirement_id === reqId);
           if (req) {
              this.rotateForm.min_rsu = req.minimum_rsu || 0;
              this.rotateForm.min_cda = req.minimum_cda || 0;
              this.rotateForm.rsu_unit = req.rsu_unit || '';
              this.rotateForm.cda_unit = req.cda_unit || '';
              this.rotateForm.is_patient_treatment = req.is_patient_treatment === true;
              
              // Default to 1 unit if required, else 0
              this.rotateForm.rsu_units = (this.rotateForm.min_rsu > 0) ? 1 : 0;
              this.rotateForm.cda_units = (this.rotateForm.min_cda > 0) ? 1 : 0;
           }
        },

        submitRotateRequirement() {
           if (!this.rotateForm.division_id || !this.rotateForm.requirement_id || !this.rotateForm.instructor_id) {
              return;
           }
           
           this.rotateSubmitting = true;
           google.script.run
             .withSuccessHandler((res) => {
                this.rotateSubmitting = false;
                if (res.success) {
                   this.rotateModalOpen = false;
                   // Optional: Show success toast?
                   // No patient list to update here really.
                } else {
                   this.showErrorModal(res.error || "Submission failed.");
                }
             })
             .withFailureHandler((err) => {
                this.rotateSubmitting = false;
                this.showErrorModal(err.message || "Submission failed.");
             })
             .studentSubmitRotateRequirement(this.rotateForm);
        }
      };
    }
  </script>

</body>
</html>
