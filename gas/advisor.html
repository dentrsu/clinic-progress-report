<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            navy:      { DEFAULT: '#1B2A4A', light: '#2A3E66', dark: '#111D35' },
            gold:      { DEFAULT: '#C4972F', light: '#D4AD4E' },
            surface:   '#F8F7F4',
            cardwhite: '#FFFFFF',
          },
          animation: {
            'fade-in': 'fadeIn 0.3s ease-out',
            'scale-in': 'scaleIn 0.2s ease-out'
          },
          keyframes: {
            fadeIn: {
              '0%': { opacity: '0' },
              '100%': { opacity: '1' },
            },
            scaleIn: {
              '0%': { opacity: '0', transform: 'scale(0.95)' },
              '100%': { opacity: '1', transform: 'scale(1)' },
            }
          }
        }
      }
    }
  </script>
  <style>
    .spinner {
      border-top-color: transparent !important;
      border-right-color: transparent !important;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 100% { transform: rotate(360deg); } }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <!-- Alpine.js -->
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <!-- Shared styles -->
  <?!= include('styles') ?>
</head>
<body class="min-h-screen bg-surface flex flex-col p-4 md:p-8"
      x-data="advisorApp()"
      x-init="init()">
    
  <!-- Loading state -->
  <div x-show="state === 'loading'" class="flex-grow flex flex-col items-center justify-center animate-fade-in">
    <div class="w-16 h-16 rounded-full bg-navy flex items-center justify-center shadow-lg mb-5">
      <svg class="w-8 h-8 text-gold" fill="none" stroke="currentColor" viewBox="0 0 24 24">
         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 14l9-5-9-5-9 5 9 5zm0 0l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14zm-4 6v-7.5l4-2.222"/>
      </svg>
    </div>
    <div class="spinner border-4 border-navy/20 border-t-navy w-10 h-10 rounded-full animate-spin mb-4"></div>
    <p class="text-sm text-gray-500 font-medium">Loading Advisor Portal...</p>
  </div>

  <!-- Error state -->
  <div x-show="state === 'error'" style="display: none;" class="flex-grow flex items-center justify-center animate-fade-in">
    <div class="bg-white p-8 rounded-2xl shadow-xl text-center max-w-sm">
      <div class="w-16 h-16 rounded-full bg-red-50 flex items-center justify-center mx-auto mb-4">
        <svg class="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"/></svg>
      </div>
      <h3 class="text-lg font-bold text-gray-800 mb-2">Access Error</h3>
      <p class="text-sm text-gray-500 mb-6" x-text="errorMessage"></p>
      <a href="<?= appUrl ?>" class="block w-full py-2 bg-gray-100 text-gray-700 font-medium rounded-lg hover:bg-gray-200 transition">Back to Lobby</a>
    </div>
  </div>

  <!-- Main Portal -->
  <div x-show="state === 'loaded'" style="display: none;" class="w-full max-w-6xl mx-auto space-y-8 animate-fade-in">
    <!-- Header -->
    <div class="bg-navy rounded-2xl p-6 md:px-8 md:py-6 text-white flex flex-col md:flex-row justify-between items-center shadow-lg gap-4">
      <div class="flex items-center gap-5">
        <div class="w-14 h-14 rounded-full bg-white/10 flex items-center justify-center border border-white/5">
            <svg class="w-7 h-7 text-gold" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
            </svg>
        </div>
        <div>
          <h1 class="text-2xl font-bold tracking-tight">Advisor Portal</h1>
          <p class="text-white/70 text-sm mt-0.5">My Advisees (<span x-text="profile.division ? profile.division.code : ''"></span>)</p>
        </div>
      </div>
      <div class="flex flex-col sm:flex-row items-center gap-3">
        <a href="<?= appUrl ?>?page=req_dashboard" target="_blank"
           class="flex items-center gap-2 px-4 py-2.5 bg-indigo-500 hover:bg-indigo-600 rounded-lg text-sm font-medium transition text-white shadow-md border border-indigo-400">
           <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
           Requirement Dashboard
        </a>
        <a href="<?= appUrl ?>" class="flex items-center gap-2 px-4 py-2.5 bg-white/10 hover:bg-white/20 rounded-lg text-sm font-medium transition text-white border border-white/20">
           <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg>
           Lobby
        </a>
      </div>
    </div>

    <!-- Students Grid -->
    <div>
      <h2 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-4 px-1">Active Advisees</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5">
        <template x-for="s in students" :key="s.student_id">
          <div @click="openModal(s)" class="bg-white rounded-xl shadow-sm border border-gray-200 p-5 hover:border-navy/30 hover:shadow-md transition-all cursor-pointer flex flex-col group relative overflow-hidden">
            <div class="absolute top-0 left-0 w-1 h-full bg-navy opacity-0 group-hover:opacity-100 transition-opacity"></div>
            
            <div class="flex items-start gap-4 mb-5">
               <div class="w-12 h-12 rounded-full bg-indigo-50 text-indigo-600 font-bold flex items-center justify-center text-lg uppercase shadow-sm border border-indigo-100 shrink-0">
                  <span x-text="getInitials(s.name)"></span>
               </div>
               <div class="truncate">
                 <h3 class="font-bold text-gray-800 text-base truncate" x-text="s.name"></h3>
                 <p class="text-[0.7rem] font-mono text-gray-500 mt-1" x-text="'ID: ' + s.academic_id"></p>
               </div>
            </div>
            
            <div class="mt-auto space-y-2">
              <div class="flex justify-between items-center text-xs">
                <span class="text-gray-400 font-medium uppercase tracking-wider">Student Year</span>
                <span class="font-bold text-navy bg-navy/5 px-2 py-0.5 rounded" x-text="s.calculated_year"></span>
              </div>
              <div class="flex justify-between items-center text-xs">
                <span class="text-gray-400 font-medium uppercase tracking-wider">Status</span>
                <span class="capitalize font-medium flex items-center gap-1.5" :class="s.status === 'active' ? 'text-indigo-600' : 'text-gray-500'">
                   <span class="w-1.5 h-1.5 rounded-full" :class="s.status === 'active' ? 'bg-indigo-500' : 'bg-gray-400'"></span>
                   <span x-text="s.status"></span>
                </span>
              </div>
            </div>
          </div>
        </template>
        
        <div x-show="students.length === 0" class="col-span-full py-16 text-center bg-white rounded-xl border border-dashed border-gray-300">
           <div class="w-12 h-12 rounded-full bg-gray-50 flex items-center justify-center mx-auto mb-3">
              <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
           </div>
           <p class="text-gray-500 font-medium">No advisees found for your division.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Student Profile Modal -->
  <div x-show="modalOpen" style="display: none;"
       class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm"
       x-transition.opacity>
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden animate-scale-in"
         @click.outside="modalOpen = false">
      <template x-if="selectedStudent">
        <div class="flex flex-col max-h-[90vh]">
           <!-- Modal Header (Navy block) -->
           <div class="bg-navy px-6 py-6 relative text-center shrink-0">
             <button @click="modalOpen = false" class="absolute top-4 right-4 text-white/50 hover:text-white transition">
               <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
             </button>
             
             <!-- Avatar -->
             <div class="w-20 h-20 rounded-full bg-gradient-to-br from-indigo-400 to-indigo-600 text-white mx-auto mb-3 flex items-center justify-center text-3xl font-bold uppercase shadow-lg border-2 border-white/20">
                <span x-text="getInitials(selectedStudent.name)"></span>
             </div>
             
             <h2 class="text-xl font-bold text-white tracking-tight leading-tight" x-text="selectedStudent.name"></h2>
             <p class="text-sm font-mono text-white/70 mt-1" x-text="selectedStudent.email"></p>
             
             <div class="mt-4 flex justify-center">
                <span class="px-3 py-1 rounded-full text-xs font-semibold bg-white/10 text-white border border-white/20 flex items-center gap-1.5 shadow-sm">
                   Student Year <span class="bg-white text-navy px-1.5 py-0.5 rounded text-[0.6rem] ml-0.5" x-text="selectedStudent.calculated_year"></span>
                </span>
             </div>
           </div>
           
           <!-- Modal Body (Details) -->
           <div class="p-6 space-y-4 overflow-y-auto">
             <div class="flex justify-between items-center text-sm border-b border-gray-100 pb-3">
                <span class="text-gray-500 font-medium">Academic ID</span>
                <span class="font-mono text-gray-800 font-semibold" x-text="selectedStudent.academic_id"></span>
             </div>
             <div class="flex justify-between items-center text-sm border-b border-gray-100 pb-3">
                <span class="text-gray-500 font-medium">Floor / Unit</span>
                <span class="font-medium text-gray-800">
                  <span x-text="selectedStudent.floor_label"></span> / <span x-text="selectedStudent.unit_id"></span>
                </span>
             </div>
             
             <div class="bg-gray-50 rounded-lg p-3 border border-gray-100">
               <div class="flex flex-col gap-1 text-xs mb-3">
                  <span class="text-gray-400 uppercase tracking-wider font-semibold">Team Leader 1</span>
                  <span class="font-medium text-gray-800" x-text="selectedStudent.team_leader_1_name"></span>
               </div>
               <div class="flex flex-col gap-1 text-xs">
                  <span class="text-gray-400 uppercase tracking-wider font-semibold">Team Leader 2</span>
                  <span class="font-medium text-gray-800" x-text="selectedStudent.team_leader_2_name"></span>
               </div>
             </div>
             
             <div class="mt-4 pt-4 border-t border-gray-100">
               <h3 class="text-sm font-bold text-gray-800 mb-3" x-text="profile.division ? profile.division.name + ' Requirements' : 'Division Requirements'"></h3>
               
               <!-- Loading State -->
               <div x-show="studentVaultLoading" class="py-8 flex flex-col items-center justify-center bg-gray-50 rounded-lg border border-gray-100">
                 <div class="spinner border-2 border-indigo-200 border-t-indigo-600 w-6 h-6 rounded-full animate-spin mb-2"></div>
                 <p class="text-xs text-gray-500">Loading progress...</p>
               </div>
               
               <!-- Vault Data -->
               <template x-if="!studentVaultLoading && studentVaultData">
                 <div class="space-y-4">
                     <!-- Empty state -->
                     <div x-show="studentVaultData.requirements.length === 0" class="py-6 text-center bg-gray-50 rounded-lg border border-dashed border-gray-200">
                         <span class="text-xs text-gray-400">No requirements assigned to this division.</span>
                     </div>
                     
                     <!-- RSU Requirements Table -->
                     <div x-show="studentVaultData.requirements.some(r => r.minimum_rsu > 0 || r.is_exam)" class="bg-white rounded-lg border border-gray-200 shadow-sm overflow-hidden">
                         <div class="px-3 py-2 bg-navy/5 border-b border-gray-100 flex items-center justify-between">
                              <span class="text-[10px] font-bold text-navy uppercase tracking-widest">RSU</span>
                         </div>
                         <div class="divide-y divide-gray-50">
                             <template x-for="req in studentVaultData.requirements" :key="'rsu_'+req.requirement_id">
                                 <div x-show="req.minimum_rsu > 0 || req.is_exam">
                                     <!-- Row -->
                                     <div @click="toggleReq('rsu_'+req.requirement_id)" class="px-3 py-3 hover:bg-indigo-50/50 cursor-pointer select-none">
                                         <div class="flex items-start gap-2">
                                             <svg class="w-3.5 h-3.5 mt-0.5 text-gray-400 transition-transform flex-shrink-0" :class="expandedReqs.has('rsu_'+req.requirement_id) ? 'rotate-90' : ''" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 5l7 7-7 7"></path>
                                             </svg>
                                             <div class="flex-1 min-w-0">
                                                 <div class="text-sm font-bold text-gray-800" x-text="req.requirement_type"></div>
                                                 <div class="mt-1.5 flex items-center justify-between gap-3">
                                                     <div class="flex-1">
                                                         <div class="flex items-end justify-between mb-1">
                                                             <span class="text-[9px] font-bold text-navy">PROGRESS</span>
                                                             <span class="text-xs font-black text-gray-900">
                                                                 <span x-text="req.current_rsu"></span>
                                                                 <template x-if="req.pending_rsu > 0"><span class="text-[9px] text-amber-500 font-bold ml-0.5" x-text="'+' + req.pending_rsu"></span></template>
                                                                 <template x-if="req.minimum_rsu > 0"><span class="text-gray-400 font-medium"> / <span x-text="req.minimum_rsu"></span></span></template>
                                                             </span>
                                                         </div>
                                                         <div class="h-1.5 w-full bg-gray-100 rounded-full overflow-hidden p-[1px]">
                                                             <div class="h-full rounded-full transition-all duration-1000 shadow-sm"
                                                                  :class="getBarColor(req.current_rsu, req.minimum_rsu)"
                                                                  :style="'width: ' + getPercent(req.current_rsu, req.minimum_rsu) + '%'">
                                                             </div>
                                                         </div>
                                                     </div>
                                                     <span class="inline-flex px-1.5 py-0.5 rounded text-[9px] font-bold uppercase tracking-wider"
                                                           :class="(req.minimum_rsu <= 0 && !req.is_exam) || (req.minimum_rsu > 0 && req.current_rsu >= req.minimum_rsu) ? 'bg-emerald-100 text-emerald-700' : 'bg-gray-100 text-gray-500'">
                                                         <span x-text="(req.minimum_rsu <= 0 && !req.is_exam) || (req.minimum_rsu > 0 && req.current_rsu >= req.minimum_rsu) ? '✓ Done' : 'Track'"></span>
                                                     </span>
                                                 </div>
                                             </div>
                                         </div>
                                     </div>
                                     <!-- Expanded Details -->
                                     <div x-show="expandedReqs.has('rsu_'+req.requirement_id)" class="px-3 pb-3 pt-1 bg-indigo-50/30 border-t border-indigo-50">
                                         <template x-if="req.records && req.records.length > 0">
                                             <div class="space-y-1.5 mt-2">
                                                 <template x-for="(rec, i) in req.records" :key="i">
                                                     <div class="flex items-center justify-between text-xs p-2 bg-white rounded border border-indigo-100/60 shadow-sm">
                                                         <div class="font-mono text-gray-600 font-medium" x-text="rec.hn"></div>
                                                         <div class="flex items-center gap-3">
                                                            <span class="font-semibold text-navy" x-text="rec.rsu_units + ' RSU'"></span>
                                                            <span class="inline-flex px-1.5 py-0.5 rounded text-[9px] font-bold uppercase"
                                                                  :class="rec.status === 'verified' ? 'bg-emerald-100 text-emerald-700' : 'bg-amber-100 text-amber-700'"
                                                                  x-text="rec.status === 'verified' ? 'VRFY' : 'PEND'">
                                                            </span>
                                                         </div>
                                                     </div>
                                                 </template>
                                             </div>
                                         </template>
                                         <template x-if="!req.records || req.records.length === 0">
                                             <p class="text-xs text-gray-400 italic py-1 pl-6">No records yet.</p>
                                         </template>
                                     </div>
                                 </div>
                             </template>
                         </div>
                     </div>
                     
                     <!-- CDA Requirements Table -->
                     <div x-show="studentVaultData.requirements.some(r => r.minimum_cda > 0 || r.is_exam)" class="bg-white rounded-lg border border-gray-200 shadow-sm overflow-hidden">
                         <div class="px-3 py-2 bg-amber-50 border-b border-gray-100 flex items-center justify-between">
                              <span class="text-[10px] font-bold text-amber-700 uppercase tracking-widest">CDA</span>
                         </div>
                         <div class="divide-y divide-gray-50">
                             <template x-for="req in studentVaultData.requirements" :key="'cda_'+req.requirement_id">
                                 <div x-show="req.minimum_cda > 0 || req.is_exam">
                                     <!-- Row -->
                                     <div @click="toggleReq('cda_'+req.requirement_id)" class="px-3 py-3 hover:bg-amber-50/50 cursor-pointer select-none">
                                         <div class="flex items-start gap-2">
                                             <svg class="w-3.5 h-3.5 mt-0.5 text-gray-400 transition-transform flex-shrink-0" :class="expandedReqs.has('cda_'+req.requirement_id) ? 'rotate-90' : ''" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 5l7 7-7 7"></path>
                                             </svg>
                                             <div class="flex-1 min-w-0">
                                                 <div class="text-sm font-bold text-gray-800" x-text="req.cda_requirement_type || req.requirement_type"></div>
                                                 <div class="mt-1.5 flex items-center justify-between gap-3">
                                                     <div class="flex-1">
                                                         <div class="flex items-end justify-between mb-1">
                                                             <span class="text-[9px] font-bold text-amber-600">PROGRESS</span>
                                                             <span class="text-xs font-black text-gray-900">
                                                                 <span x-text="req.current_cda"></span>
                                                                 <template x-if="req.pending_cda > 0"><span class="text-[9px] text-amber-500 font-bold ml-0.5" x-text="'+' + req.pending_cda"></span></template>
                                                                 <template x-if="req.minimum_cda > 0"><span class="text-gray-400 font-medium"> / <span x-text="req.minimum_cda"></span></span></template>
                                                             </span>
                                                         </div>
                                                         <div class="h-1.5 w-full bg-gray-100 rounded-full overflow-hidden p-[1px]">
                                                             <div class="h-full rounded-full transition-all duration-1000 shadow-sm"
                                                                  :class="getBarColor(req.current_cda, req.minimum_cda)"
                                                                  :style="'width: ' + getPercent(req.current_cda, req.minimum_cda) + '%'">
                                                             </div>
                                                         </div>
                                                     </div>
                                                     <span class="inline-flex px-1.5 py-0.5 rounded text-[9px] font-bold uppercase tracking-wider"
                                                           :class="(req.minimum_cda <= 0 && !req.is_exam) || (req.minimum_cda > 0 && req.current_cda >= req.minimum_cda) ? 'bg-emerald-100 text-emerald-700' : 'bg-gray-100 text-gray-500'">
                                                         <span x-text="(req.minimum_cda <= 0 && !req.is_exam) || (req.minimum_cda > 0 && req.current_cda >= req.minimum_cda) ? '✓ Done' : 'Track'"></span>
                                                     </span>
                                                 </div>
                                             </div>
                                         </div>
                                     </div>
                                     <!-- Expanded Details -->
                                     <div x-show="expandedReqs.has('cda_'+req.requirement_id)" class="px-3 pb-3 pt-1 bg-amber-50/30 border-t border-amber-50">
                                         <template x-if="req.records && req.records.length > 0">
                                             <div class="space-y-1.5 mt-2">
                                                 <template x-for="(rec, i) in req.records" :key="i">
                                                     <div class="flex items-center justify-between text-xs p-2 bg-white rounded border border-amber-100/60 shadow-sm">
                                                         <div class="font-mono text-gray-600 font-medium" x-text="rec.hn"></div>
                                                         <div class="flex items-center gap-3">
                                                            <span class="font-semibold text-amber-700" x-text="rec.cda_units + ' CDA'"></span>
                                                            <span class="inline-flex px-1.5 py-0.5 rounded text-[9px] font-bold uppercase"
                                                                  :class="rec.status === 'verified' ? 'bg-emerald-100 text-emerald-700' : 'bg-amber-100 text-amber-700'"
                                                                  x-text="rec.status === 'verified' ? 'VRFY' : 'PEND'">
                                                            </span>
                                                         </div>
                                                     </div>
                                                 </template>
                                             </div>
                                         </template>
                                         <template x-if="!req.records || req.records.length === 0">
                                             <p class="text-xs text-gray-400 italic py-1 pl-6">No records yet.</p>
                                         </template>
                                     </div>
                                 </div>
                             </template>
                         </div>
                     </div>
                 </div>
               </template>
               <template x-if="!studentVaultLoading && !studentVaultData">
                   <div class="py-4 text-center">
                       <p class="text-xs text-red-500 bg-red-50 p-3 rounded">Failed to load requirements. Please try again later.</p>
                   </div>
               </template>
             </div>
           </div>
           
           <!-- Modal Footer -->
           <div class="px-6 py-4 bg-gray-50 border-t border-gray-100 shrink-0">
              <button @click="modalOpen = false" class="w-full py-2 bg-white border border-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-100 transition shadow-sm text-sm">Close</button>
           </div>
        </div>
      </template>
    </div>
  </div>

  <script>
    function advisorApp() {
      return {
        state: 'loading',
        errorMessage: '',
        students: [],
        profile: {},
        modalOpen: false,
        selectedStudent: null,
        
        // Vault specific properties
        studentVaultLoading: false,
        studentVaultData: null,
        expandedReqs: new Set(),
        
        init() {
          google.script.run
            .withSuccessHandler(res => {
               this.profile = res.profile || {};
               this.students = res.students || [];
               this.state = 'loaded';
            })
            .withFailureHandler(err => {
               this.errorMessage = err.message || "An unexpected error occurred.";
               this.state = 'error';
            })
            .advisorGetAdvisees();
        },
        
        getInitials(name) {
          if (!name) return '?';
          var parts = name.trim().split(/\s+/);
          if (parts.length === 0) return '?';
          
          var firstPart = '';
          var lastPart = '';
          var firstWord = parts[0];

          if (firstWord.indexOf('.') !== -1) {
            var dotParts = firstWord.split('.');
            var afterLastDot = dotParts[dotParts.length - 1];
            if (afterLastDot.length > 0) {
               firstPart = afterLastDot;
            } else {
               firstPart = parts.length > 1 ? parts[1] : '';
            }
          } else {
            var knownTitles = ['นาย', 'นาง', 'นางสาว', 'นพ', 'ทพ', 'ดร', 'ทญ'];
            if (knownTitles.indexOf(firstWord) !== -1 || parts.length >= 3) {
              firstPart = parts.length > 1 ? parts[1] : '';
            } else {
              firstPart = firstWord;
            }
          }
          
          lastPart = parts.length > 1 ? parts[parts.length - 1] : '';

          function getConsonant(str) {
            if (!str) return '';
            var match = str.match(/[ก-ฮa-zA-Z]/);
            return match ? match[0] : str.charAt(0);
          }
          var initials = getConsonant(firstPart) + (lastPart ? getConsonant(lastPart) : '');
          return initials.toUpperCase();
        },
        
        // --- Vault Helpers ---
        toggleReq(key) {
            if (this.expandedReqs.has(key)) {
                this.expandedReqs.delete(key);
            } else {
                this.expandedReqs.add(key);
            }
            this.expandedReqs = new Set(this.expandedReqs); // trigger reactivity
        },

        getPercent(current, min) {
            if (!min || min <= 0) return current > 0 ? 100 : 0;
            let p = (current / min) * 100;
            return Math.min(Math.max(p, 0), 100);
        },

        getBarColor(current, min) {
            if (!min || min <= 0) return 'bg-navy';
            const p = (current / min) * 100;
            if (p >= 100) return 'bg-emerald-500';
            if (p >= 70) return 'bg-navy';
            if (p >= 30) return 'bg-indigo-500';
            return 'bg-amber-400';
        },
        
        openModal(student) {
          this.selectedStudent = student;
          
          // Reset and fetch vault for this student and division
          this.studentVaultData = null;
          this.expandedReqs.clear();
          
          if (this.profile && this.profile.division && this.profile.division.name) {
             this.studentVaultLoading = true;
             google.script.run
               .withSuccessHandler(data => {
                  this.studentVaultData = data;
                  this.studentVaultLoading = false;
               })
               .withFailureHandler(err => {
                  console.error('Failed to load student vault:', err);
                  this.studentVaultLoading = false;
               })
               .advisorGetStudentDivisionVault(student.student_id, this.profile.division.name);
          }
          
          this.modalOpen = true;
        }
      }
    }
  </script>
</body>
</html>
